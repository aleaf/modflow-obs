<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mfobs.obs &mdash; modflow-obs 0.post77.dev0+g3cd2580 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            modflow-obs
          </a>
              <div class="version">
                0.post77.dev0+g3cd2580
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../philosophy.html">Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Example.html">Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Example.html"> Demo of Modflow-obs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Code reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html"> Modules</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Release history</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../release-history.html"> Release History</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing to modflow-obs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">modflow-obs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">mfobs.obs</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mfobs.obs</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">General functions for creating observation input for PEST, </span>
<span class="sd">including base observations representing field measurements and simulated equivalents, </span>
<span class="sd">and derivative observations that are created from the base observations.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">mfobs.checks</span> <span class="kn">import</span> <span class="n">check_obsnme_suffix</span>
<span class="kn">from</span> <span class="nn">mfobs.fileio</span> <span class="kn">import</span> <span class="n">write_insfile</span><span class="p">,</span> <span class="n">get_insfile_observations</span>
<span class="kn">from</span> <span class="nn">mfobs.sep</span> <span class="kn">import</span> <span class="n">ih_method</span>
<span class="kn">from</span> <span class="nn">mfobs.utils</span> <span class="kn">import</span> <span class="n">fill_nats</span><span class="p">,</span> <span class="n">set_period_start_end_dates</span>


<div class="viewcode-block" id="get_base_obs"><a class="viewcode-back" href="../../api/mfobs.obs.html#mfobs.obs.get_base_obs">[docs]</a><span class="k">def</span> <span class="nf">get_base_obs</span><span class="p">(</span><span class="n">perioddata</span><span class="p">,</span>
            <span class="n">model_output</span><span class="p">,</span>
            <span class="n">observed_values_file</span><span class="p">,</span>
            <span class="n">variable_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">simulated_values_column</span><span class="o">=</span><span class="s1">&#39;sim_obsval&#39;</span><span class="p">,</span>
            <span class="n">observed_values_metadata_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">observed_values_site_id_col</span><span class="o">=</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">,</span>
            <span class="n">observed_values_datetime_col</span><span class="o">=</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span>
            <span class="n">obsnme_date_suffix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">obsnme_suffix_format</span><span class="o">=</span><span class="s1">&#39;%Y%m&#39;</span><span class="p">,</span>
            <span class="n">observed_values_obsval_col</span><span class="o">=</span><span class="s1">&#39;obsval&#39;</span><span class="p">,</span>
            <span class="n">observed_values_group_column</span><span class="o">=</span><span class="s1">&#39;obgnme&#39;</span><span class="p">,</span>
            <span class="n">observed_values_unc_column</span><span class="o">=</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">,</span>
            <span class="n">aggregrate_observed_values_method</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span>
            <span class="n">drop_groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">label_period_as_steady_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">steady_state_period_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">steady_state_period_end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">forecast_sites</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">forecast_start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">forecast_end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">forecasts_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">forecast_sites_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">write_ins</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a set of base observations from a tables of model output, observed </span>
<span class="sd">    values, and model time discretizaton.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    perioddata : str, pathlike or DataFrame</span>
<span class="sd">        Path to csv file or pandas DataFrame with start/end dates for stress periods or timesteps. </span>
<span class="sd">        Must have a `start_datetime` and either a `time` column </span>
<span class="sd">        (of elapsed times at the end of each period, in days), </span>
<span class="sd">        or an `end_datetime` column of period end dates.</span>
<span class="sd">        </span>
<span class="sd">        =================== =======================================================</span>
<span class="sd">        start_datetime      start date for each stress period or timestep</span>
<span class="sd">        end_datetime        (optional) end date for each stress period or timestep</span>
<span class="sd">        time                (optional) elapsed simulation time at the end of each </span>
<span class="sd">                            period, in days</span>
<span class="sd">        =================== =======================================================</span>

<span class="sd">    model_output : DataFrame</span>
<span class="sd">        DataFrame with one head observation per row, with the following columns:</span>

<span class="sd">        ======================= =============================================================</span>
<span class="sd">        site_no                 unique identifier for each site</span>
<span class="sd">        variable                variable name for the simulated values</span>
<span class="sd">        obsprefix               prefix of observation name (&lt;site_no&gt;-&lt;variable&gt;)</span>
<span class="sd">        simulated_values_column column with simulated values</span>
<span class="sd">        datetime                pandas datetimes, based on stress period end date</span>
<span class="sd">        layer                   zero-based model layer</span>
<span class="sd">        obsnme                  observation name based on format of &lt;obsprefix&gt;_&#39;%Y%m&#39;</span>
<span class="sd">        ======================= =============================================================</span>
<span class="sd">        </span>
<span class="sd">        Usually, a helper function such as :func:`mfobs.modflow.get_mf6_single_variable_obs`</span>
<span class="sd">        or other custom code will be used to produce model_output from the </span>
<span class="sd">        raw model output files.</span>
<span class="sd">        </span>
<span class="sd">        Observation prefixes in the `obsprefix` column are assumed to be formated as</span>
<span class="sd">        **&lt;site_no&gt;-&lt;variable&gt;**, where `site_no` is a unique identifier for a site</span>
<span class="sd">        contained in `observed_values_file` and `variable` matches the `variable_name` argument</span>
<span class="sd">        to this function (and is the variable name for the observed values in `observed_values_file`).</span>
<span class="sd">        </span>
<span class="sd">    observed_values_file : str, pathlike or DataFrame</span>
<span class="sd">        Path to csv file or pandas DataFrame with observed values.</span>
<span class="sd">        Must have the following columns (column names in brackets &lt;&gt; are supplied</span>
<span class="sd">        with other arguments to this function):</span>

<span class="sd">        ============================== ================================================================================</span>
<span class="sd">        &lt;observed_values_obsval_col&gt;   Column with observed values</span>
<span class="sd">        &lt;observed_values_site_id_col&gt;  Column with unique identifier for each site</span>
<span class="sd">        &lt;observed_values_datetime_col&gt; Column with date/time for each observation</span>
<span class="sd">        &lt;observed_values_unc_column&gt;   Column with estimated uncertainty values for each observation</span>
<span class="sd">        ============================== ================================================================================</span>
<span class="sd">    variable_name : str, optional</span>
<span class="sd">        Name for the type of values being processed, </span>
<span class="sd">        e.g. &#39;head&#39;, &#39;downstream-flow&#39; or &#39;stage&#39;. Required if the `obsprefix`</span>
<span class="sd">        values in the `model_output` table are formatted as **&lt;site number&gt;-&lt;variable&gt;**;</span>
<span class="sd">        if supplied, the observation names created for the observations in </span>
<span class="sd">        `observed_values_file` will also have **&lt;site number&gt;-&lt;variable&gt;** prefixes,</span>
<span class="sd">        and the observed values and simulated equivalents can be aligned.</span>
<span class="sd">        </span>
<span class="sd">        By default, None, in which case the `obsprefix` values in the `model_output`</span>
<span class="sd">        table are assumed to be the site numbers; prefixes for observations</span>
<span class="sd">        in `observed_values_file` will also then be site numbers.</span>
<span class="sd">    simulated_values_column : str, optional</span>
<span class="sd">        Column in model output with simulated values</span>
<span class="sd">    observed_values_metadata_file : str, pathlike or DataFrame, optional</span>
<span class="sd">        Table with site information for the observed values.</span>

<span class="sd">    observed_values_obsval_col : str, optional</span>
<span class="sd">        Column in obs_values_file with measured values</span>
<span class="sd">    observed_values_site_id_col : str</span>
<span class="sd">        Column with unique identifier for each site,</span>
<span class="sd">        by default, &#39;obsprefix&#39;</span>
<span class="sd">    observed_values_datetime_col : str</span>
<span class="sd">        Column with date/time for each observation,</span>
<span class="sd">        by default, &#39;datetime&#39;</span>
<span class="sd">    observed_values_unc_column : str</span>
<span class="sd">        Column with estimated uncertainty values for each observation,</span>
<span class="sd">        by default, &#39;uncertainty&#39;</span>
<span class="sd">    aggregrate_observed_values_method : str</span>
<span class="sd">        Method for aggregating observed values to time periods bracked by </span>
<span class="sd">        aggregate_start_dates and aggregate_end_dates.</span>
<span class="sd">        Can be any method used to aggregate values on a pandas groupby object</span>
<span class="sd">        (e.g. &#39;mean&#39;, &#39;last&#39;, etc.)</span>
<span class="sd">    obsnme_date_suffix : bool</span>
<span class="sd">        If true, give observations a date-based suffix. Otherwise, assign a </span>
<span class="sd">        stress period- or timestep-based suffix. In either case, the format of the suffix</span>
<span class="sd">        is controlled by obsnme_suffix_format.</span>
<span class="sd">        by default True</span>
<span class="sd">    obsnme_suffix_format : str, optional</span>
<span class="sd">        Format for suffix of obsnmes. Observation names are created following the format of</span>
<span class="sd">        &lt;obsprefix&gt;_&lt;date or stress period suffix&gt;. By default, ``&#39;%Y%m&#39;``,</span>
<span class="sd">        which would yield ``&#39;202001&#39;`` for a Jan, 2020 observation </span>
<span class="sd">        (obsnme_date_suffix=True). If obsnme_date_suffix=False, obsnme_suffix_format</span>
<span class="sd">        should be a decimal format in the &quot;new-style&quot; string format</span>
<span class="sd">        (e.g. &#39;{:03d}&#39;, which would yield ``&#39;001&#39;`` for stress period 1.)</span>
<span class="sd">    label_period_as_steady_state : int, optional</span>
<span class="sd">        Zero-based model stress period where observations will be</span>
<span class="sd">        assigned the suffix &#39;ss&#39; instead of a date suffix.</span>
<span class="sd">        By default, None, in which case all model output is assigned</span>
<span class="sd">        a date suffix based on the start date of the stress period.</span>
<span class="sd">        Passed to :func:`~mfobs.modflow.get_mf6_single_variable_obs`.</span>
<span class="sd">    steady_state_period_start : str, optional</span>
<span class="sd">        Start date for the period representing steady-state conditions.</span>
<span class="sd">        Observations between ``steady_state_period_start`` and ``steady_state_period_end``</span>
<span class="sd">        will be averaged to create additional observations with the suffix &#39;ss&#39;.</span>
<span class="sd">        The steady-state averages will be matched to model output from the</span>
<span class="sd">        stress period specified by ``label_period_as_steady_state``.</span>
<span class="sd">        By default None, in which case all observations are used </span>
<span class="sd">        (if ``observed_values_datetime_col is None``) </span>
<span class="sd">        or no steady-state observations </span>
<span class="sd">        are created (``observed_values_datetime_col`` exists).</span>
<span class="sd">    steady_state_period_end : str, optional</span>
<span class="sd">        End date for the period representing steady-state conditions.</span>
<span class="sd">        By default None, in which case all observations are used </span>
<span class="sd">        (if ``observed_values_datetime_col is None``) </span>
<span class="sd">        or no steady-state observations </span>
<span class="sd">        are created (``observed_values_datetime_col`` exists).</span>
<span class="sd">    forecast_sites : str or sequence, optional</span>
<span class="sd">        At these sites, observations will be created for each simulated value,</span>
<span class="sd">        regardless is there is an observed equivalent. Can be supplied</span>
<span class="sd">        as a sequence of site numbers (`site_id`s) or ``&#39;all&#39;`` to</span>
<span class="sd">        include all sites. By default, None (no forecast sites).</span>
<span class="sd">    forecast_start_date : str, optional</span>
<span class="sd">        Start date for forecast period. When forecast_sites is not</span>
<span class="sd">        ``None``, forecast observations will be generated for each</span>
<span class="sd">        time between `forecast_start_date` and `forecast_end_date`.</span>
<span class="sd">        By default, None (generate forecasts for any time with missing values).</span>
<span class="sd">    forecast_end_date : str, optional</span>
<span class="sd">        End date for forecast period. When forecast_sites is not</span>
<span class="sd">        ``None``, forecast observations will be generated for each</span>
<span class="sd">        time between `forecast_start_date` and `forecast_end_date`.</span>
<span class="sd">        By default, None (generate forecasts for any time with missing values).</span>
<span class="sd">    forecasts_only : bool, optional</span>
<span class="sd">        Use this option to only output forecast observations </span>
<span class="sd">        (those without an observed equivalent), subject to the parameters of</span>
<span class="sd">        `forecast_sites`, `forecast_start_date`, and `forecast_end_date`.</span>
<span class="sd">    forecast_sites_only : bool, optional</span>
<span class="sd">        Option to only output observations at sites specified</span>
<span class="sd">        with `forecast_sites` (has no effect if ``forecast_sites=&#39;all&#39;``). If</span>
<span class="sd">        ``forecasts_only=False``, the output will include forecast and non-forecast</span>
<span class="sd">        observations (for a continuous time-series).</span>
<span class="sd">    outfile : str, optional</span>
<span class="sd">        [description], by default &#39;processed_flux_obs.dat&#39;</span>
<span class="sd">    write_ins : bool, optional</span>
<span class="sd">        [description], by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    base_obs : DataFrame</span>
<span class="sd">        Table of base observations with the following columns:</span>
<span class="sd">        </span>
<span class="sd">        =================== =============================================================</span>
<span class="sd">        datetime            pandas datetimes, based on stress period end date</span>
<span class="sd">        per                 MODFLOW stress period</span>
<span class="sd">        site_no             unique site identifier</span>
<span class="sd">        obsprefix           prefix of observation name</span>
<span class="sd">        obsnme              observation name based on format of &lt;obsprefix&gt;_&lt;suffix&gt;</span>
<span class="sd">        obsval              observed values</span>
<span class="sd">        sim_obsval          simulated equivalents to observed values</span>
<span class="sd">        obgnme              observation group name</span>

<span class="sd">        =================== =============================================================</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># validation checks</span>
    <span class="n">check_obsnme_suffix</span><span class="p">(</span><span class="n">obsnme_date_suffix</span><span class="p">,</span> <span class="n">obsnme_suffix_format</span><span class="p">,</span> 
                        <span class="n">function_name</span><span class="o">=</span><span class="s1">&#39;get_base_obs&#39;</span><span class="p">)</span>
    
    <span class="n">outpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>

    <span class="c1">#obs_values_column = &#39;obsval&#39;</span>
    <span class="n">output_sim_values_column</span> <span class="o">=</span> <span class="s1">&#39;sim_obsval&#39;</span>
    <span class="n">output_obs_values_column</span> <span class="o">=</span> <span class="s1">&#39;obsval&#39;</span>
    <span class="c1">#if variable_name is None:</span>
    <span class="c1">#    obs_values_column = &#39;obsval&#39;  #&#39;obs_value&#39;</span>
    <span class="c1">#    #sim_values_column = &#39;sim_value&#39;</span>
    <span class="c1">#else:</span>
    <span class="c1">#    obs_values_column = &#39;obs_&#39; + variable_name  # output column with observed values</span>
    <span class="c1">#    #sim_values_column = &#39;sim_&#39; + variable_name  # output column with simulated equivalents to observed values</span>

    <span class="c1"># read in/set up the perioddata table</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">perioddata</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">perioddata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">perioddata</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">perioddata</span> <span class="o">=</span> <span class="n">perioddata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>        
    <span class="n">set_period_start_end_dates</span><span class="p">(</span><span class="n">perioddata</span><span class="p">)</span>
    <span class="c1">#perioddata.index = perioddata.per</span>

    <span class="c1"># model results</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">model_output</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># rename columns to their defaults</span>
    <span class="n">renames</span> <span class="o">=</span> <span class="p">{</span><span class="n">observed_values_site_id_col</span><span class="p">:</span> <span class="s1">&#39;site_no&#39;</span><span class="p">,</span>
               <span class="n">observed_values_datetime_col</span><span class="p">:</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span>
               <span class="n">observed_values_group_column</span><span class="p">:</span> <span class="s1">&#39;obgnme&#39;</span><span class="p">,</span>
               <span class="n">observed_values_unc_column</span><span class="p">:</span> <span class="s1">&#39;uncertainty&#39;</span>
               <span class="p">}</span>

    <span class="c1"># read in/set up the observed values table</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_values_file</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">observed_values_file</span><span class="p">,</span>
                               <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="n">observed_values_site_id_col</span><span class="p">:</span> <span class="nb">object</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">observed_values_file</span>
    <span class="n">observed</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">renames</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;obsprefix&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">variable_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">observed</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2">&quot;</span> 
                                     <span class="k">for</span> <span class="n">sn</span> <span class="ow">in</span> <span class="n">observed</span><span class="p">[</span><span class="s1">&#39;site_no&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">forecast_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">forecast_sites</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">forecast_sites</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">variable_name</span><span class="si">}</span><span class="s2">&quot;</span> 
                                     <span class="k">for</span> <span class="n">sn</span> <span class="ow">in</span> <span class="n">forecast_sites</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">observed</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">observed</span><span class="p">[</span><span class="s1">&#39;site_no&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">observed</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">observed</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

    <span class="c1"># read in the observed values metadata</span>
    <span class="k">if</span> <span class="n">observed_values_metadata_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_values_metadata_file</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">observed_values_metadata_file</span><span class="p">,</span>
                               <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="n">observed_values_site_id_col</span><span class="p">:</span> <span class="nb">object</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">observed_values_metadata_file</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">renames</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;obsprefix&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="n">observed_values_site_id_col</span><span class="p">]</span>

        <span class="c1"># join the metadata to the observed data</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">observed</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">observed</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">join_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;screen_top&#39;</span><span class="p">,</span> <span class="s1">&#39;screen_botm&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;layer&#39;</span><span class="p">]</span>
                     <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">observed</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="n">join_cols</span><span class="p">])</span>

    <span class="c1"># convert obs names and prefixes to lower case</span>
    <span class="n">observed</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">observed</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># make a dictionary of site metadata for possible use later</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">observed</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">temp</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">site_info_dict</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;obsval&#39;</span><span class="p">,</span> <span class="n">observed_values_obsval_col</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">site_info_dict</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">site_info_dict</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        
    <span class="k">del</span> <span class="n">temp</span>

    <span class="c1"># cast datetimes to pandas datetimes</span>
    <span class="c1"># (observed data may not have a datetime col. if model is steady-state)</span>
    <span class="k">if</span> <span class="s1">&#39;datetime&#39;</span> <span class="ow">in</span> <span class="n">observed</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">observed</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">observed</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">])</span>
        <span class="c1"># not necessarily True</span>
        <span class="n">observed</span><span class="p">[</span><span class="s1">&#39;steady&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># flag for steady-state observations</span>
    <span class="k">elif</span> <span class="n">label_period_as_steady_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">observed</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
            <span class="n">perioddata</span><span class="p">[</span><span class="s1">&#39;start_datetime&#39;</span><span class="p">][</span><span class="n">label_period_as_steady_state</span><span class="p">])</span>
        <span class="n">observed</span><span class="p">[</span><span class="s1">&#39;steady&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">perioddata</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">observed</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">perioddata</span><span class="p">[</span><span class="s1">&#39;start_datetime&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">observed</span><span class="p">[</span><span class="s1">&#39;steady&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model has more than one stress period &quot;</span>
                             <span class="s2">&quot;but observed data have no &#39;datetime&#39; column.&quot;</span><span class="p">)</span>

    <span class="c1"># drop model results that aren&#39;t in the obs information file</span>
    <span class="c1"># these are probably observations that aren&#39;t in the model time period</span>
    <span class="c1"># (and therefore weren&#39;t included in the parent model calibration;</span>
    <span class="c1"># but modflow-setup would include them in the MODFLOW observation input)</span>
    <span class="c1"># also drop sites that are in the obs information file, but not in the model results</span>
    <span class="c1"># these include sites outside of the model (i.e. in the inset when looking at the parent)</span>
    <span class="n">no_info_sites</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">obsprefix</span><span class="p">)</span><span class="o">.</span><span class="n">symmetric_difference</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">obsprefix</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">forecast_sites</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="c1"># forecast observations at all simulated sites</span>
        <span class="c1"># (only drop sites that aren&#39;t simulated)</span>
        <span class="n">no_info_sites</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">obsprefix</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">obsprefix</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">forecast_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># remove selected forecast sites from &#39;no_info&#39; sites to drop</span>
        <span class="n">forecast_sites</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">forecast_sites</span><span class="p">}</span>
        <span class="n">no_info_sites</span> <span class="o">=</span> <span class="n">no_info_sites</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">forecast_sites</span><span class="p">)</span>
        
    <span class="c1"># dump these out to a csv</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dropping </span><span class="si">{}</span><span class="s1"> sites with no information&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">no_info_sites</span><span class="p">)))</span>
    <span class="n">dropped_obs_outfile</span> <span class="o">=</span> <span class="n">outpath</span> <span class="o">/</span> <span class="s1">&#39;dropped_head_observation_sites.csv&#39;</span>
    <span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">results</span><span class="o">.</span><span class="n">obsprefix</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">no_info_sites</span><span class="p">)]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">dropped_obs_outfile</span><span class="p">,</span>
                                                              <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">results</span><span class="o">.</span><span class="n">obsprefix</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">no_info_sites</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">observed</span> <span class="o">=</span> <span class="n">observed</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">observed</span><span class="o">.</span><span class="n">obsprefix</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">no_info_sites</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No matches between observation prefixes in the model results&quot;</span>
                         <span class="s2">&quot;and observed values! Check that the obsprefixes in the &quot;</span>
                         <span class="s2">&quot;observed_values_file match those in the model_output DataFrame.&quot;</span><span class="p">)</span>

    <span class="c1"># for each model stress period or timestep, get the simulated values</span>
    <span class="c1"># and the observed equivalents</span>
    <span class="n">observed</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">observed</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
    <span class="n">observed</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># integer column for stress period- or timestep-based obsnme suffixes</span>
    <span class="c1"># timestep-based observations</span>
    <span class="k">if</span> <span class="s1">&#39;timestep&#39;</span> <span class="ow">in</span> <span class="n">perioddata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">perioddata</span><span class="p">[</span><span class="s1">&#39;unique_timestep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">perioddata</span><span class="p">)))</span>
        <span class="n">per_column</span> <span class="o">=</span> <span class="s1">&#39;unique_timestep&#39;</span>
    <span class="c1"># stress period-based observations</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">per_column</span> <span class="o">=</span> <span class="s1">&#39;per&#39;</span>
        
    <span class="n">observed_simulated_combined</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># if no datetime column is supplied with observations,</span>
    <span class="c1"># only make steady state obs</span>
    <span class="k">if</span> <span class="n">observed_values_datetime_col</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> \
        <span class="n">label_period_as_steady_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">label_period_as_steady_state</span>
            <span class="n">perioddata</span> <span class="o">=</span> <span class="n">perioddata</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">perioddata</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

        <span class="c1"># get the equivalent observed values</span>
        <span class="c1">#start, end = perioddata.loc[per, [&#39;start_datetime&#39;, &#39;end_datetime&#39;]]</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;start_datetime&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;end_datetime&#39;</span><span class="p">]</span>
        
        <span class="c1"># date-based suffix</span>
        <span class="k">if</span> <span class="n">obsnme_date_suffix</span><span class="p">:</span>  
            <span class="n">suffix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">end</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">obsnme_suffix_format</span><span class="p">)</span>
        <span class="c1"># stress or timestep-based period-based suffix</span>
        <span class="k">else</span><span class="p">:</span>  
            <span class="n">suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">r</span><span class="p">[</span><span class="n">per_column</span><span class="p">]</span><span class="si">:{</span><span class="n">obsnme_suffix_format</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}}</span><span class="s2">&quot;</span>

        <span class="c1"># steady-state observations can represent a period</span>
        <span class="c1"># other than the &quot;modflow time&quot; in the perioddata table</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label_period_as_steady_state</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;ss&#39;</span>
            <span class="k">if</span> <span class="n">steady_state_period_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">steady_state_period_start</span>
            <span class="k">if</span> <span class="n">steady_state_period_end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">steady_state_period_end</span>
        <span class="c1"># don&#39;t process observations for a steady-state period unless </span>
        <span class="c1"># it is explicitly labeled as such and given a representative date range</span>
        <span class="k">elif</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;steady&#39;</span><span class="p">]:</span>
            <span class="k">continue</span>
        <span class="n">observed_in_period_rs</span> <span class="o">=</span> <span class="n">aggregrate_to_period</span><span class="p">(</span>
            <span class="n">observed</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> 
            <span class="n">aggregrate_observed_values_method</span><span class="o">=</span><span class="n">aggregrate_observed_values_method</span><span class="p">,</span>
            <span class="n">obsnme_suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">forecast_sites</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed_in_period_rs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">per_column</span> <span class="o">==</span> <span class="s1">&#39;per&#39;</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">((</span><span class="s1">&#39;Stress period </span><span class="si">{}</span><span class="s1">: No observations between start and &#39;</span>
                                <span class="s1">&#39;end dates of </span><span class="si">{}</span><span class="s1"> and </span><span class="si">{}</span><span class="s1">!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">],</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)))</span>
            <span class="k">continue</span>

        <span class="c1"># get the simulated equivalents</span>
        <span class="c1"># first populate obsnmes</span>
        <span class="n">sim_in_period_rs</span> <span class="o">=</span> <span class="n">aggregrate_to_period</span><span class="p">(</span>
            <span class="n">results</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> 
            <span class="n">aggregrate_observed_values_method</span><span class="o">=</span><span class="n">aggregrate_observed_values_method</span><span class="p">,</span>
            <span class="n">obsnme_suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">sim_in_period_rs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">per_column</span> <span class="o">==</span> <span class="s1">&#39;per&#39;</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">((</span><span class="s1">&#39;Stress period </span><span class="si">{}</span><span class="s1">: No simulated equivalents between start and &#39;</span>
                                <span class="s1">&#39;end dates of </span><span class="si">{}</span><span class="s1"> and </span><span class="si">{}</span><span class="s1">!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">],</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)))</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">forecast_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">observed_in_period_rs</span> <span class="o">=</span> <span class="n">observed_in_period_rs</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">sim_in_period_rs</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">obsprefix</span> <span class="o">=</span> <span class="n">observed_in_period_rs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">observed_in_period_rs</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obsprefix</span>
            <span class="n">observed_in_period_rs</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">observed_in_period_rs</span><span class="o">.</span><span class="n">index</span>
            <span class="n">observed_in_period_rs</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim_in_period_rs</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">any_simulated_obs</span> <span class="o">=</span> <span class="n">sim_in_period_rs</span><span class="o">.</span><span class="n">obsnme</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">observed_in_period_rs</span><span class="o">.</span><span class="n">obsnme</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">any_simulated_obs</span> <span class="ow">and</span> <span class="p">(</span><span class="n">per_column</span> <span class="o">==</span> <span class="s1">&#39;per&#39;</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">((</span><span class="s1">&#39;Stress period </span><span class="si">{}</span><span class="s1">: No observation/simulated equivalent pairs for start and &#39;</span>
                            <span class="s1">&#39;end dates of </span><span class="si">{}</span><span class="s1"> and </span><span class="si">{}</span><span class="s1">!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">],</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)))</span>
            <span class="k">continue</span>
                
        <span class="n">observed_in_period_rs</span><span class="p">[</span><span class="n">output_sim_values_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim_in_period_rs</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">observed_in_period_rs</span><span class="o">.</span><span class="n">index</span><span class="p">)[</span><span class="n">simulated_values_column</span><span class="p">]</span>

        <span class="c1"># add stress period and observed values</span>
        <span class="n">observed_in_period_rs</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">per_column</span> <span class="o">==</span> <span class="s1">&#39;unique_timestep&#39;</span><span class="p">:</span>
            <span class="n">observed_in_period_rs</span><span class="p">[</span><span class="s1">&#39;timestep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;timestep&#39;</span><span class="p">]</span>
            <span class="n">observed_in_period_rs</span><span class="p">[</span><span class="s1">&#39;unique_timestep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;unique_timestep&#39;</span><span class="p">]</span>
        <span class="n">observed_in_period_rs</span><span class="p">[</span><span class="n">output_obs_values_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">observed_in_period_rs</span><span class="p">[</span><span class="n">observed_values_obsval_col</span><span class="p">]</span>
        <span class="n">observed_simulated_combined</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">observed_in_period_rs</span><span class="p">)</span>

    <span class="c1"># Combined DataFrame of observed heads and simulated equivalents</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">observed_simulated_combined</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;No overlap between model results &quot;</span>
               <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">%Y-%m-%d</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">%Y-%m-%d</span><span class="si">}</span><span class="s2">)&quot;</span>
               <span class="s2">&quot; and observed values &quot;</span>
               <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">observed</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">%Y-%m-%d</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">observed</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">%Y-%m-%d</span><span class="si">}</span><span class="s2">)!&quot;</span>
               <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">obsdata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">observed_simulated_combined</span><span class="p">)</span>

    <span class="c1"># raise an error if there are duplicates- reindexing below will fail if this is the case</span>
    <span class="k">if</span> <span class="n">obsdata</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The following observations have duplicate names. There should only be&#39;</span>
               <span class="s1">&#39;one observation per site, for each time period implied by the &#39;</span>
               <span class="s1">&#39;obsnme_date_suffix_format parameter.</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span>
               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obsdata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">obsdata</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># drop any observations in specified groups</span>
    <span class="c1"># (e.g. lake stages that should be compared with lake package output)</span>
    <span class="k">if</span> <span class="n">drop_groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;obgnme&#39;</span> <span class="ow">in</span> <span class="n">obsdata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">obsdata</span> <span class="o">=</span> <span class="n">obsdata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">obsdata</span><span class="o">.</span><span class="n">obgnme</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">drop_groups</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
    <span class="k">if</span> <span class="s1">&#39;obgnme&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obsdata</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable_name</span>
    
    <span class="c1"># fill forecast obs with site info from observed dataframe</span>
    <span class="k">if</span> <span class="n">forecast_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">site_info_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">obsdata</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span> 
                          <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">current</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">],</span> <span class="n">obsdata</span><span class="p">[</span><span class="n">k</span><span class="p">])]</span>
        <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obsdata</span><span class="o">.</span><span class="n">index</span>
    <span class="k">else</span><span class="p">:</span>  
        <span class="c1"># nans are where sites don&#39;t have observation values for that period</span>
        <span class="c1"># or sites that are in other model (inset or parent)</span>
        <span class="n">obsdata</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">output_obs_values_column</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># label forecasts in own group</span>
    <span class="k">if</span> <span class="n">forecast_sites</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">is_forecast</span> <span class="o">=</span> <span class="n">obsdata</span><span class="p">[</span><span class="n">output_obs_values_column</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
        <span class="n">obsdata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">is_forecast</span><span class="p">,</span> <span class="s1">&#39;obgnme&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;-forecast&#39;</span>
    
        <span class="c1"># cull forecasts to specified date window</span>
        <span class="c1"># and specific sites (if specified)</span>
        <span class="n">keep_forecasts</span> <span class="o">=</span> <span class="n">is_forecast</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1">#np.array([True] * len(head_obs))</span>
        <span class="k">if</span> <span class="n">forecast_start_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keep_forecasts</span> <span class="o">=</span> <span class="p">(</span><span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">forecast_start_date</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">forecast_end_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">keep_forecasts</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">forecast_end_date</span><span class="p">)</span>
        <span class="c1">#drop = drop &amp; is_forecast</span>
        <span class="c1">#head_obs = head_obs.loc[~drop].copy()</span>
        <span class="c1">#is_forecast = head_obs[output_obs_values_column].isna()</span>
        <span class="k">if</span> <span class="n">forecast_sites</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">keep_forecasts</span> <span class="o">&amp;=</span> <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">forecast_sites</span><span class="p">)</span>
        <span class="c1"># option to only include forecast obs</span>
        <span class="c1"># (those without observed equivalents)</span>
        <span class="k">if</span> <span class="n">forecasts_only</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="n">keep_forecasts</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="n">keep_forecasts</span> <span class="o">|</span> <span class="o">~</span><span class="n">is_forecast</span>
        <span class="c1"># option to only include output from designated forecast sites</span>
        <span class="k">if</span> <span class="n">forecast_sites_only</span><span class="p">:</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="n">keep</span> <span class="o">&amp;</span> <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">forecast_sites</span><span class="p">)</span>
        <span class="n">obsdata</span> <span class="o">=</span> <span class="n">obsdata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
    <span class="c1"># add standard obsval and obgmne columns</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;per&#39;</span><span class="p">,</span> <span class="s1">&#39;site_no&#39;</span><span class="p">,</span> <span class="s1">&#39;obsprefix&#39;</span><span class="p">,</span> <span class="s1">&#39;obsnme&#39;</span><span class="p">,</span> 
               <span class="n">output_obs_values_column</span><span class="p">,</span> <span class="n">output_sim_values_column</span><span class="p">,</span>
               <span class="s1">&#39;uncertainty&#39;</span><span class="p">,</span> <span class="s1">&#39;obgnme&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">output_obs_values_column</span> <span class="o">!=</span> <span class="s1">&#39;obsval&#39;</span><span class="p">:</span>
        <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;obsval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obsdata</span><span class="p">[</span><span class="n">output_obs_values_column</span><span class="p">]</span>
        <span class="n">columns</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;obsval&#39;</span><span class="p">)</span>


    <span class="c1"># reorder the columns</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">obsdata</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">base_obs</span> <span class="o">=</span> <span class="n">obsdata</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;layer&#39;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="n">base_obs</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_obs</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># fill NaT (not a time) datetimes</span>
    <span class="n">fill_nats</span><span class="p">(</span><span class="n">base_obs</span><span class="p">,</span> <span class="n">perioddata</span><span class="p">)</span>

    <span class="n">base_obs</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">,</span> <span class="s1">&#39;per&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">base_obs</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mf">1e30</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;wrote </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">base_obs</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1"> observations to </span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># write the instruction file</span>
        <span class="k">if</span> <span class="n">write_ins</span><span class="p">:</span>
            <span class="n">write_insfile</span><span class="p">(</span><span class="n">base_obs</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.ins&#39;</span><span class="p">,</span> <span class="n">obsnme_column</span><span class="o">=</span><span class="s1">&#39;obsnme&#39;</span><span class="p">,</span>
                          <span class="n">simulated_obsval_column</span><span class="o">=</span><span class="n">output_sim_values_column</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">base_obs</span></div>


<div class="viewcode-block" id="aggregrate_to_period"><a class="viewcode-back" href="../../api/mfobs.obs.html#mfobs.obs.aggregrate_to_period">[docs]</a><span class="k">def</span> <span class="nf">aggregrate_to_period</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">obsnme_suffix</span><span class="p">,</span>
                         <span class="n">aggregrate_observed_values_method</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span>
                         <span class="p">):</span>

    <span class="n">data_in_period</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_in_period</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">]</span>
        <span class="n">data_in_period_rs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
        <span class="n">data_in_period_rs</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">data_in_period_rs</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data_in_period_rs</span>
    <span class="n">data_in_period</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;n&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_in_period</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">data_in_period</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>    
    <span class="n">by_site</span> <span class="o">=</span> <span class="n">data_in_period</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">)</span>
    <span class="n">data_in_period_rs</span> <span class="o">=</span> <span class="n">by_site</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">data_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">data_in_period</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
                    <span class="k">if</span> <span class="s1">&#39;float&#39;</span> <span class="ow">in</span> <span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data_cols</span><span class="p">:</span>
        <span class="n">data_in_period_rs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">by_site</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">aggregrate_observed_values_method</span><span class="p">)()</span>
    <span class="n">data_in_period_rs</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">by_site</span><span class="o">.</span><span class="n">n</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">data_in_period_rs</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
    <span class="n">data_in_period_rs</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># put obsprefix back</span>
    
    <span class="n">missing_cols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">data_in_period</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">data_in_period_rs</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">missing_cols</span><span class="p">:</span>
        <span class="n">data_in_period_rs</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">by_site</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">data_in_period_rs</span> <span class="o">=</span> <span class="n">data_in_period_rs</span><span class="p">[</span><span class="n">data_in_period</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">obsnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">obsnme_suffix</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">data_in_period_rs</span><span class="o">.</span><span class="n">obsprefix</span><span class="p">]</span>
    <span class="n">data_in_period_rs</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obsnames</span>
    <span class="n">data_in_period_rs</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">data_in_period_rs</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">data_in_period_rs</span></div>


<div class="viewcode-block" id="get_spatial_differences"><a class="viewcode-back" href="../../api/mfobs.obs.html#mfobs.obs.get_spatial_differences">[docs]</a><span class="k">def</span> <span class="nf">get_spatial_differences</span><span class="p">(</span><span class="n">base_data</span><span class="p">,</span> <span class="n">perioddata</span><span class="p">,</span>
                            <span class="n">difference_sites</span><span class="p">,</span>
                            <span class="n">obs_values_col</span><span class="o">=</span><span class="s1">&#39;obs_head&#39;</span><span class="p">,</span>
                            <span class="n">sim_values_col</span><span class="o">=</span><span class="s1">&#39;sim_head&#39;</span><span class="p">,</span>
                            <span class="n">use_gradients</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;-d-&#39;</span><span class="p">,</span>
                            <span class="n">write_ins</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes the base_data dataframe output by :func:`mfobs.obs.get_obs` and creates</span>
<span class="sd">    spatial difference observations. Optionally writes an output csvfile</span>
<span class="sd">    and a PEST instruction file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    base_data : DataFrame</span>
<span class="sd">        Table of preprocessed observations, such as that produced by</span>
<span class="sd">        :func:`mfobs.obs.get_base_obs`. Must have the following columns:</span>
<span class="sd">        </span>
<span class="sd">        =================== ========================================================================</span>
<span class="sd">        datetime            pandas datetimes, based on stress period end date</span>
<span class="sd">        per                 MODFLOW stress period</span>
<span class="sd">        site_no             unique site identifier</span>
<span class="sd">        obsprefix\ :sup:`1` prefix of observation name</span>
<span class="sd">        obsnme              observation name based on format of &lt;obsprefix&gt;_&lt;suffix&gt;</span>
<span class="sd">        obsval              observed values</span>
<span class="sd">        sim_obsval          simulated equivalents to observed values</span>
<span class="sd">        obgnme              observation group name</span>
<span class="sd">        screen_top          (optional) well open interval top; required if ``use_gradients=True``</span>
<span class="sd">        screen_botm         (optional) well open interval bottom; required if ``use_gradients=True``</span>
<span class="sd">        =================== ========================================================================</span>
<span class="sd">        </span>
<span class="sd">        1) where obsprefix is assumed to be formatted as &lt;site_no&gt;-&lt;variable&gt; or simply &lt;site_no&gt;</span>
<span class="sd">        </span>
<span class="sd">    perioddata : DataFrame</span>
<span class="sd">        DataFrame with start/end dates for stress periods. Must have columns</span>
<span class="sd">        &#39;time&#39; (modflow time, in days), &#39;start_datetime&#39; (start date for the stress period)</span>
<span class="sd">        and &#39;end_datetime&#39; (end date for the stress period).</span>
<span class="sd">    difference_sites : dict</span>
<span class="sd">        Dictionary of site numbers (keys) and other site numbers to compare to (values).</span>
<span class="sd">        Values can be a string for a single site, a list of strings for multiple sites,</span>
<span class="sd">        or a string pattern contained in multiple site numbers;</span>
<span class="sd">        observations at the sites represented in the values will be compared to the observation</span>
<span class="sd">        at the site represented by the key, at times of coincident measurements. Differences</span>
<span class="sd">        are computed by subtracting the values site(s) from the key site, so for example,</span>
<span class="sd">        to represent a gain in streamflow as positive, the downstream site should be key site.</span>
<span class="sd">    obs_values_col : str</span>
<span class="sd">        Column in ``base_data`` with observed values</span>
<span class="sd">    sim_values_col : str</span>
<span class="sd">        Column in `base_data`` with simulated equivalent values</span>
<span class="sd">    use_gradients : bool</span>
<span class="sd">        If True, compute vertical hydraulic gradients and use those for the</span>
<span class="sd">        observation values, if False, use differences. For this option,</span>
<span class="sd">        &#39;screen_top&#39; and &#39;screen_botm&#39; columns are needed in ``base_data``.</span>
<span class="sd">        By default False.</span>
<span class="sd">    sep : str</span>
<span class="sd">        Separator in spatial difference obsnnames. For example, with</span>
<span class="sd">        sites &quot;site1&quot; and &quot;site2&quot; at time &quot;202001&quot;, and sep=&#39;-d-&#39;, the obsnme</span>
<span class="sd">        would be &quot;site1-d-site2_202001&quot;.</span>
<span class="sd">        by default, &#39;-d-&#39;</span>
<span class="sd">    outfile : str, optional</span>
<span class="sd">        CSV file to write output to. Nan values are filled with -1e30.</span>
<span class="sd">        By default, None (no output written)</span>
<span class="sd">    write_ins : bool, optional</span>
<span class="sd">        Option to write instruction file, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    spatial_differences : DataFrame</span>
<span class="sd">        Spatial difference observations. Columns:</span>

<span class="sd">        ================= ===================================================================================</span>
<span class="sd">        datetime          observation date-time labels</span>
<span class="sd">        per               model stress period</span>
<span class="sd">        obsprefix         observation name prefix (site identifier)</span>
<span class="sd">        obsnme1           name of observation from keys of ``difference_sites``</span>
<span class="sd">        &lt;obs_values_col&gt;1 observed value associated with obsnme1</span>
<span class="sd">        &lt;sim_values_col&gt;1 simulated equivalent associated with obsnme1</span>
<span class="sd">        screen_top1       well screen top (elevation) associated with obsnme1*</span>
<span class="sd">        screen_botm1      well screen botm (elevation) associated with obsnme1*</span>
<span class="sd">        layer1            model layer associated with obsnme1*</span>
<span class="sd">        obsnme2           name of observation from value(s) in ``difference_sites`` (associated with obsnme1)</span>
<span class="sd">        &lt;obs_values_col&gt;2 observed value associated with obsnme2</span>
<span class="sd">        &lt;sim_values_col&gt;2 simulated equivalent associated with obsnme2</span>
<span class="sd">        screen_top2       well screen top (elevation) associated with obsnme2*</span>
<span class="sd">        screen_botm2      well screen botm (elevation) associated with obsnme2*</span>
<span class="sd">        layer2            model layer associated with obsnme2*</span>
<span class="sd">        obs_diff          observed difference between obsnme1 and obsnme2</span>
<span class="sd">        sim_diff          simulated equivalent difference between obsnme1 and obsnme2</span>
<span class="sd">        dz                distance between well screen midpoints for obsnme1 and obsnme2*</span>
<span class="sd">        obs_grad          observed vertical hydraulic gradient between obsnme1 and obsnme2*</span>
<span class="sd">        sim_grad          simulated equivalent vertical hydraulic gradient between obsnme1 and obsnme2*</span>
<span class="sd">        obgnme            observation group</span>
<span class="sd">        obsnme            spatial difference observation name</span>
<span class="sd">        obsval            observation value (i.e. for PEST control file)</span>
<span class="sd">        sim_obsval        simulated equivalent (i.e. for PEST instruction file)</span>
<span class="sd">        type              description of spatial difference observations</span>
<span class="sd">        uncertainty       (loosely) error-based uncertainty, assumed to be 2x that of obsnme2</span>
<span class="sd">        ================= ===================================================================================</span>

<span class="sd">        Notes:</span>

<span class="sd">        * * denotes optional columns that may not be present.</span>
<span class="sd">        * Columns relating to well open interval are only created if </span>
<span class="sd">          ``base_data`` has &#39;screen_top&#39; and &#39;screen_botm&#39; columns.</span>
<span class="sd">        * Negative difference or gradient values indicate a gradient towards the key site.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># model stress period data:</span>
    <span class="n">perioddata</span> <span class="o">=</span> <span class="n">perioddata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># make sure start and end dates don&#39;t overlap</span>
    <span class="n">set_period_start_end_dates</span><span class="p">(</span><span class="n">perioddata</span><span class="p">)</span>
    <span class="n">perioddata</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">perioddata</span><span class="o">.</span><span class="n">per</span>

    <span class="c1"># rename the observed and sim. eq. values columns</span>
    <span class="c1">#if variable is not None:</span>
    <span class="c1">#    renames = {obs_values_col: f&#39;obs_{variable}&#39;,</span>
    <span class="c1">#            sim_values_col: f&#39;sim_{variable}&#39;,</span>
    <span class="c1">#            }</span>
    <span class="c1">#    obs_values_col = f&#39;obs_{variable}&#39;</span>
    <span class="c1">#    sim_values_col = f&#39;sim_{variable}&#39;</span>
    <span class="c1">#else:</span>
    <span class="n">renames</span> <span class="o">=</span> <span class="p">{</span><span class="n">obs_values_col</span><span class="p">:</span> <span class="s1">&#39;base_obsval&#39;</span><span class="p">,</span>  <span class="c1"># f&#39;obs_{variable}&#39;,</span>
            <span class="n">sim_values_col</span><span class="p">:</span> <span class="s1">&#39;base_sim_obsval&#39;</span><span class="p">,</span>  <span class="c1"># f&#39;sim_{variable}&#39;,</span>
            <span class="p">}</span>
    <span class="n">obs_values_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;base_obsval&#39;</span>
    <span class="n">sim_values_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;base_sim_obsval&#39;</span>
    <span class="n">base_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="c1">#f&#39;obs_{variable}&#39;, f&#39;sim_{variable}&#39;, </span>
                    <span class="s1">&#39;base_obsval&#39;</span><span class="p">,</span> <span class="s1">&#39;bas_sim_obsval&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                   <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    <span class="n">base_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">renames</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># rename the observed and sim. eq. values columns</span>
    <span class="c1">#renames = {obs_values_col: f&#39;obs_{variable}&#39;,</span>
    <span class="c1">#           sim_values_col: f&#39;sim_{variable}&#39;,</span>
    <span class="c1">#           }</span>
    <span class="c1">#base_data.drop([f&#39;obs_{variable}&#39;, f&#39;sim_{variable}&#39;], axis=1, </span>
    <span class="c1">#               inplace=True, errors=&#39;ignore&#39;)</span>
    <span class="c1">#base_data.rename(columns=renames, inplace=True)</span>
    <span class="c1">#obs_values_col = f&#39;obs_{variable}&#39;</span>
    <span class="c1">#sim_values_col = f&#39;sim_{variable}&#39;</span>
    
    <span class="c1"># get a set of unique variables</span>
    <span class="c1"># (including &#39;&#39;, which signifies no variable in the obsprefix, </span>
    <span class="c1">#  just a site number)</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span> 
                 <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">]}</span>
    
    <span class="c1"># get subset of base_data sites to compare to each key site in difference_sites</span>
    <span class="n">base_data_obsprefixes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">])</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">base_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">)</span>
    <span class="n">spatial_differences</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># key site: value/comparison sites can be include variables or not</span>
    <span class="c1"># if they don&#39;t, and the base_data includes variables, </span>
    <span class="c1"># process each obsprefix with that site number</span>
    <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key_obsprefix</span><span class="p">,</span> <span class="n">patterns</span> <span class="ow">in</span> <span class="n">difference_sites</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">key_obsprefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key_obsprefix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">&quot;</span>
                
            <span class="k">if</span> <span class="n">key_obsprefix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base_data_obsprefixes</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">((</span><span class="sa">f</span><span class="s1">&#39;warning: observation prefix </span><span class="si">{</span><span class="n">key_obsprefix</span><span class="si">}</span><span class="s1"> not in base_data. &#39;</span>
                    <span class="s1">&#39;Skipping spatial differencing.&#39;</span><span class="p">))</span>
                <span class="k">continue</span>
            
            <span class="n">compare</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">patterns</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">patterns</span><span class="p">]</span>
            <span class="c1"># matching obsprefixes must have the pattern and the variable</span>
            <span class="c1"># if obsprefixes are simply formatted as site numbers</span>
            <span class="c1"># (no variables)</span>
            <span class="c1"># then the only variable will be an empty string,</span>
            <span class="c1"># which will match any string</span>
            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
                <span class="n">matches</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span> <span class="k">if</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">obsprefix</span> <span class="ow">and</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">obsprefix</span> 
                            <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">obsprefix</span> <span class="ow">in</span> <span class="n">base_data</span><span class="o">.</span><span class="n">obsprefix</span><span class="p">]</span>
                <span class="n">compare</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>
            <span class="n">compare</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">compare</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">prefixes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">base_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">compare</span><span class="p">,</span> <span class="s1">&#39;obsprefix&#39;</span><span class="p">])</span>

            <span class="c1"># for each site in the subset, compare the values to the keys site</span>
            <span class="c1"># index by stress period</span>
            <span class="n">key_values</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">key_obsprefix</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">key_values</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">key_values</span><span class="o">.</span><span class="n">per</span>

            <span class="k">for</span> <span class="n">obsprefix</span><span class="p">,</span> <span class="n">site_observations</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">obsprefix</span> <span class="ow">in</span> <span class="n">prefixes</span><span class="p">:</span>
                    <span class="n">site_obs</span> <span class="o">=</span> <span class="n">site_observations</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">site_obs</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">obs_values_col</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obs_values_col</span><span class="si">}</span><span class="s2">2&quot;</span><span class="p">,</span>  <span class="c1"># &#39;obs_head2&#39;,</span>
                                            <span class="n">sim_values_col</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sim_values_col</span><span class="si">}</span><span class="s2">2&quot;</span><span class="p">,</span>  <span class="c1"># &#39;sim_head2&#39;,</span>
                                            <span class="s1">&#39;obsnme&#39;</span><span class="p">:</span> <span class="s1">&#39;obsnme2&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;screen_top&#39;</span><span class="p">:</span> <span class="s1">&#39;screen_top2&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;screen_botm&#39;</span><span class="p">:</span> <span class="s1">&#39;screen_botm2&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;layer&#39;</span><span class="p">:</span> <span class="s1">&#39;layer2&#39;</span>
                                            <span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">site_obs</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">site_obs</span><span class="o">.</span><span class="n">per</span>
                    <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;obsnme1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_values</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">]</span>
                    <span class="n">site_obs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obs_values_col</span><span class="si">}</span><span class="s2">1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_values</span><span class="p">[</span><span class="n">obs_values_col</span><span class="p">]</span>
                    <span class="n">site_obs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sim_values_col</span><span class="si">}</span><span class="s2">1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_values</span><span class="p">[</span><span class="n">sim_values_col</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;screen_top&#39;</span> <span class="ow">in</span> <span class="n">key_values</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;screen_top1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_values</span><span class="p">[</span><span class="s1">&#39;screen_top&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">use_gradients</span> <span class="ow">and</span> <span class="s1">&#39;screen_botm&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key_values</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;use_gradients=True requires both screen_top &quot;</span>
                                             <span class="s2">&quot;and screen_botm columns in base_data&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;screen_botm&#39;</span> <span class="ow">in</span> <span class="n">key_values</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;screen_botm1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_values</span><span class="p">[</span><span class="s1">&#39;screen_botm&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;layer2&#39;</span> <span class="ow">in</span> <span class="n">site_obs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;layer1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_values</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span>
                    <span class="c1"># negative values indicate gradient towards key site</span>
                    <span class="c1"># (key site head &lt; values site head)</span>
                    <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;obs_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">site_obs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obs_values_col</span><span class="si">}</span><span class="s2">1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">site_obs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obs_values_col</span><span class="si">}</span><span class="s2">2&quot;</span><span class="p">]</span>
                    <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;sim_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">site_obs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sim_values_col</span><span class="si">}</span><span class="s2">1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">site_obs</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sim_values_col</span><span class="si">}</span><span class="s2">2&quot;</span><span class="p">]</span>

                    <span class="c1"># get a screen midpoint and add gradient</span>
                    <span class="n">screen_midpoint1</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">use_gradients</span> <span class="ow">and</span> <span class="p">{</span><span class="s1">&#39;screen_top1&#39;</span><span class="p">,</span> <span class="s1">&#39;screen_botm1&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">site_obs</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                        <span class="n">screen_midpoint1</span> <span class="o">=</span> <span class="n">site_obs</span><span class="p">[[</span><span class="s1">&#39;screen_top1&#39;</span><span class="p">,</span> <span class="s1">&#39;screen_botm1&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">use_gradients</span> <span class="ow">and</span> <span class="p">{</span><span class="s1">&#39;screen_top2&#39;</span><span class="p">,</span> <span class="s1">&#39;screen_botm2&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">site_obs</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                        <span class="n">screen_midpoint2</span> <span class="o">=</span> <span class="n">site_obs</span><span class="p">[[</span><span class="s1">&#39;screen_top2&#39;</span><span class="p">,</span> <span class="s1">&#39;screen_botm2&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">screen_midpoint1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;dz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">screen_midpoint1</span> <span class="o">-</span> <span class="n">screen_midpoint2</span><span class="p">)</span>
                            <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;obs_grad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;obs_diff&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;dz&#39;</span><span class="p">]</span>
                            <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;sim_grad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;sim_diff&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;dz&#39;</span><span class="p">]</span>
                            
                    <span class="c1"># default obgnme prefix</span>
                    <span class="k">if</span> <span class="s1">&#39;obgnme&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">site_obs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sdiff&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span>
                    <span class="c1"># obgnme = &lt;prefix&gt;_sdiff</span>
                    <span class="c1"># unless there is no prefix</span>
                    <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g</span><span class="si">}</span><span class="s1">_sdiff&#39;</span> <span class="k">if</span> <span class="n">g</span> <span class="o">!=</span> <span class="s1">&#39;sdiff&#39;</span> <span class="k">else</span> <span class="n">g</span> 
                                          <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">]]</span>
                        
                     <span class="c1"># whether to use gradients for the obsvals, or just head differences</span>
                    <span class="k">if</span> <span class="n">use_gradients</span><span class="p">:</span>
                        <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;obsval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;obs_grad&#39;</span><span class="p">]</span>
                        <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;sim_obsval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;sim_grad&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;gradient&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1"> gradient&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;obsval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;obs_diff&#39;</span><span class="p">]</span>
                        <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;sim_obsval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;sim_diff&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;spatial difference&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">site_obs</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;spatial </span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1"> difference&#39;</span>
                    <span class="n">spatial_differences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site_obs</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spatial_differences</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No spatial difference site/variable pairs found! &#39;</span>
                         <span class="s1">&#39;Check that the key sites and their compare patterns exist in the base_data.&#39;</span><span class="p">)</span>
        
    <span class="n">spatial_differences</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">spatial_differences</span><span class="p">)</span>
    <span class="n">spatial_differences</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;obs_diff&#39;</span><span class="p">,</span> <span class="s1">&#39;sim_diff&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># name the spatial head difference obs as</span>
    <span class="c1"># &lt;obsprefix1&gt;&lt;sep&gt;&lt;obsprefix2&gt;_&lt;suffix&gt;</span>
    <span class="n">obsnme</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">obsprefix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">spatial_differences</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">prefix1</span><span class="p">,</span> <span class="n">suffix1</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">obsnme1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">prefix2</span><span class="p">,</span> <span class="n">suffix2</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">obsnme2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">suffix1</span> <span class="o">==</span> <span class="n">suffix2</span><span class="p">,</span> <span class="s2">&quot;Observations are at different times! </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">obsnme1</span><span class="p">,</span>
                                                                                        <span class="n">r</span><span class="o">.</span><span class="n">obsnme2</span><span class="p">)</span>
        <span class="c1"># if the obsprefixes include variables; only retain the the second instance</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}{</span><span class="n">sep</span><span class="si">}{</span><span class="n">prefix2</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">obsnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">suffix2</span><span class="p">))</span>
        <span class="n">obsprefix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
    <span class="n">spatial_differences</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obsnme</span>
    <span class="n">spatial_differences</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obsprefix</span>

    <span class="c1"># clean up columns</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;per&#39;</span><span class="p">,</span> <span class="s1">&#39;obsprefix&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;obsnme1&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obs_values_col</span><span class="si">}</span><span class="s2">1&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sim_values_col</span><span class="si">}</span><span class="s2">1&quot;</span><span class="p">,</span> <span class="s1">&#39;screen_top1&#39;</span><span class="p">,</span> <span class="s1">&#39;screen_botm1&#39;</span><span class="p">,</span> <span class="s1">&#39;layer1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;obsnme2&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obs_values_col</span><span class="si">}</span><span class="s2">2&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sim_values_col</span><span class="si">}</span><span class="s2">2&quot;</span><span class="p">,</span> <span class="s1">&#39;screen_top2&#39;</span><span class="p">,</span> <span class="s1">&#39;screen_botm2&#39;</span><span class="p">,</span> <span class="s1">&#39;layer2&#39;</span><span class="p">,</span>
            <span class="s1">&#39;obs_diff&#39;</span><span class="p">,</span> <span class="s1">&#39;sim_diff&#39;</span><span class="p">,</span> <span class="s1">&#39;dz&#39;</span><span class="p">,</span> <span class="s1">&#39;obs_grad&#39;</span><span class="p">,</span> <span class="s1">&#39;sim_grad&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;obsnme&#39;</span><span class="p">,</span> <span class="s1">&#39;obsval&#39;</span><span class="p">,</span> <span class="s1">&#39;sim_obsval&#39;</span><span class="p">,</span> <span class="s1">&#39;obgnme&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span>
            <span class="p">]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">spatial_differences</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">spatial_differences</span> <span class="o">=</span> <span class="n">spatial_differences</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>

    <span class="n">spatial_differences</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;obsval&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># uncertainty column is from base_data;</span>
    <span class="c1"># assume that spatial head differences have double the uncertainty</span>
    <span class="c1"># (two wells/two measurements per obs)</span>
    <span class="k">if</span> <span class="s1">&#39;uncertainty&#39;</span> <span class="ow">in</span> <span class="n">spatial_differences</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">spatial_differences</span><span class="p">[</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">2</span>

    <span class="c1"># check for duplicates</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">spatial_differences</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>

    <span class="c1"># fill NaT (not a time) datetimes</span>
    <span class="n">fill_nats</span><span class="p">(</span><span class="n">spatial_differences</span><span class="p">,</span> <span class="n">perioddata</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spatial_differences</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mf">1e30</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;wrote </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">spatial_differences</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1"> observations to </span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># write the instruction file</span>
        <span class="k">if</span> <span class="n">write_ins</span><span class="p">:</span>
            <span class="n">write_insfile</span><span class="p">(</span><span class="n">spatial_differences</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.ins&#39;</span><span class="p">,</span>
                          <span class="n">obsnme_column</span><span class="o">=</span><span class="s1">&#39;obsnme&#39;</span><span class="p">,</span>
                          <span class="n">simulated_obsval_column</span><span class="o">=</span><span class="s1">&#39;sim_obsval&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spatial_differences</span></div>


<div class="viewcode-block" id="get_temporal_differences"><a class="viewcode-back" href="../../api/mfobs.obs.html#mfobs.obs.get_temporal_differences">[docs]</a><span class="k">def</span> <span class="nf">get_temporal_differences</span><span class="p">(</span><span class="n">base_data</span><span class="p">,</span> <span class="n">perioddata</span><span class="p">,</span>
                             <span class="n">obs_values_col</span><span class="o">=</span><span class="s1">&#39;obs_head&#39;</span><span class="p">,</span>
                             <span class="n">sim_values_col</span><span class="o">=</span><span class="s1">&#39;sim_head&#39;</span><span class="p">,</span>
                             <span class="n">variable</span><span class="o">=</span><span class="s1">&#39;head&#39;</span><span class="p">,</span>
                             <span class="n">get_displacements</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">displacement_from</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">obsnme_date_suffix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">obsnme_suffix_format</span><span class="o">=</span><span class="s1">&#39;%Y%m&#39;</span><span class="p">,</span>
                             <span class="n">exclude_suffix</span><span class="o">=</span><span class="s1">&#39;ss&#39;</span><span class="p">,</span>
                             <span class="n">exclude_obs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">write_ins</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes the base_data dataframe output by :func:`mfobs.obs.get_obs`,</span>
<span class="sd">    creates temporal difference observations. Optionally writes an output csvfile</span>
<span class="sd">    and a PEST instruction file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    base_data : DataFrame</span>
<span class="sd">        Head observation data with same column structure as</span>
<span class="sd">        output from :func:`mfobs.obs.get_obs`</span>
<span class="sd">    perioddata : DataFrame</span>
<span class="sd">        DataFrame with start/end dates for stress periods. Must have columns</span>
<span class="sd">        &#39;time&#39; (modflow time, in days), &#39;start_datetime&#39; (start date for the stress period)</span>
<span class="sd">        and &#39;end_datetime&#39; (end date for the stress period).</span>
<span class="sd">    obs_values_col : str</span>
<span class="sd">        Column in ``base_data`` with observed values</span>
<span class="sd">    sim_values_col : str</span>
<span class="sd">        Column in `base_data`` with simulated equivalent values</span>
<span class="sd">    variable : str  {&#39;head&#39;, &#39;flux&#39;, or other}</span>
<span class="sd">        Type of observation being processed. Simulated and observed values</span>
<span class="sd">        columns are named in the format &#39;sim_&lt;variable&gt;&#39; and &#39;obs_&lt;variable&gt;&#39;,</span>
<span class="sd">        respectively. If there is no &#39;obgnme&#39; column in ``base_data``,</span>
<span class="sd">        ``variable`` is also used as a default base group name.</span>
<span class="sd">    get_displacements : bool</span>
<span class="sd">        If True, compute the displacement of each observation from </span>
<span class="sd">        a datum (specified by ``displacement_from``). If False, difference</span>
<span class="sd">        each observation with the previous observation.</span>
<span class="sd">        by default, False</span>
<span class="sd">    displacement_from : str or date-like</span>
<span class="sd">        Datum for computing displacements. Must be in a format that can be</span>
<span class="sd">        used for time slicing in pandas (e.g. &#39;2010-01-01&#39;, which would result</span>
<span class="sd">        in displacements from the first observation on or after &#39;2010-01-01&#39; at each site,</span>
<span class="sd">        or None, which would result in displacements from the first observation </span>
<span class="sd">        at each site. By default, None</span>
<span class="sd">    non-zero weighted observation</span>
<span class="sd">    obsnme_date_suffix : bool</span>
<span class="sd">        If true, give observations a date-based suffix. Otherwise, assign a </span>
<span class="sd">        stress period-based suffix. In either case, the format of the suffix</span>
<span class="sd">        is controlled by obsnme_suffix_format.</span>
<span class="sd">        by default True</span>
<span class="sd">    obsnme_suffix_format : str, optional</span>
<span class="sd">        Format for suffix of obsnmes. Observation names are created following the format of</span>
<span class="sd">        &lt;obsprefix&gt;_&lt;date or stress period suffix&gt;. By default, ``&#39;%Y%m&#39;``,</span>
<span class="sd">        which would yield ``&#39;202001&#39;`` for a Jan, 2020 observation </span>
<span class="sd">        (obsnme_date_suffix=True). If obsnme_date_suffix=False, obsnme_suffix_format</span>
<span class="sd">        should be a decimal format in the &quot;new-style&quot; string format</span>
<span class="sd">        (e.g. &#39;{:03d}&#39;, which would yield ``&#39;001&#39;`` for stress period 1.)</span>
<span class="sd">    exclude_suffix : str or list-like</span>
<span class="sd">        Option to exclude observations from differencing by suffix;</span>
<span class="sd">        e.g. &#39;ss&#39; to include steady-state observations.</span>
<span class="sd">        By default, &#39;ss&#39;</span>
<span class="sd">    exclude_obs : list-like</span>
<span class="sd">        Sequence of observation names to exclude from return/written dataset. For example,</span>
<span class="sd">        if sequential head differences are also being computed, the first displacement observation</span>
<span class="sd">        after the reference observation will be a duplicate of the first sequential head difference</span>
<span class="sd">        observation. By default, None (no observations excluded).</span>
<span class="sd">    outfile : str, optional</span>
<span class="sd">        CSV file to write output to.</span>
<span class="sd">        By default, None (no output written)</span>
<span class="sd">    write_ins : bool, optional</span>
<span class="sd">        Option to write instruction file, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    period_diffs : DataFrame</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Differences are computed by subtracting the previous time from the current,</span>
<span class="sd">    so a positive value indicates an increase.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">base_data</span> <span class="o">=</span> <span class="n">base_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">])</span>
    
    <span class="c1"># validation checks</span>
    <span class="n">check_obsnme_suffix</span><span class="p">(</span><span class="n">obsnme_date_suffix</span><span class="p">,</span> <span class="n">obsnme_suffix_format</span><span class="p">,</span> 
                        <span class="n">function_name</span><span class="o">=</span><span class="s1">&#39;get_head_obs&#39;</span><span class="p">,</span> <span class="n">obsdata</span><span class="o">=</span><span class="n">base_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">base_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Duplicate column names in base_data:</span><span class="se">\n</span><span class="s1">&#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">base_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># rename the observed and sim. eq. values columns</span>
    <span class="k">if</span> <span class="n">variable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">renames</span> <span class="o">=</span> <span class="p">{</span><span class="n">obs_values_col</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;obs_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">sim_values_col</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;sim_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="p">}</span>
        <span class="n">obs_values_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;obs_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">sim_values_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;sim_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">renames</span> <span class="o">=</span> <span class="p">{</span><span class="n">obs_values_col</span><span class="p">:</span> <span class="s1">&#39;base_obsval&#39;</span><span class="p">,</span>  <span class="c1"># f&#39;obs_{variable}&#39;,</span>
                <span class="n">sim_values_col</span><span class="p">:</span> <span class="s1">&#39;base_sim_obsval&#39;</span><span class="p">,</span>  <span class="c1"># f&#39;sim_{variable}&#39;,</span>
                <span class="p">}</span>
        <span class="n">obs_values_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;base_obsval&#39;</span>
        <span class="n">sim_values_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;base_sim_obsval&#39;</span>
    <span class="n">base_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;obs_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;sim_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;base_obsval&#39;</span><span class="p">,</span> <span class="s1">&#39;bas_sim_obsval&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                   <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    <span class="n">base_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">renames</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    
    <span class="c1"># rename the observed and sim. eq. values columns</span>
    <span class="c1">#renames = {obs_values_col: f&#39;obs_{variable}&#39;,</span>
    <span class="c1">#           sim_values_col: f&#39;sim_{variable}&#39;,</span>
    <span class="c1">#           }</span>
    <span class="c1">#base_data.drop([f&#39;obs_{variable}&#39;, f&#39;sim_{variable}&#39;], axis=1, </span>
    <span class="c1">#               inplace=True, errors=&#39;ignore&#39;)</span>
    <span class="c1">#base_data.rename(columns=renames, inplace=True)</span>
    <span class="c1">#obs_values_col = f&#39;obs_{variable}&#39;</span>
    <span class="c1">#sim_values_col = f&#39;sim_{variable}&#39;</span>
    
    <span class="c1"># only compute differences on transient obs</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exclude_suffix</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">exclude_suffix</span> <span class="o">=</span> <span class="p">[</span><span class="n">exclude_suffix</span><span class="p">]</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="p">[</span><span class="n">obsnme</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">obsnme</span> <span class="ow">in</span> <span class="n">base_data</span><span class="o">.</span><span class="n">obsnme</span><span class="p">]</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">exclude_suffix</span><span class="p">)</span>
    <span class="n">base_data</span> <span class="o">=</span> <span class="n">base_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># group observations by site (prefix)</span>
    <span class="n">sites</span> <span class="o">=</span> <span class="n">base_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">)</span>
    <span class="n">period_diffs</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># get index position for obsval columns,</span>
    <span class="c1"># after adding them if needed</span>
    <span class="c1"># (this allows assignment of new values purely by iloc, </span>
    <span class="c1">#  which avoids setting on slices in loop below)</span>
    <span class="k">if</span> <span class="s1">&#39;obsval&#39;</span> <span class="ow">in</span> <span class="n">base_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">obsval_col_iloc</span> <span class="o">=</span> <span class="n">base_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;obsval&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;obsval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e30</span>
        <span class="n">obsval_col_iloc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="s1">&#39;sim_obsval&#39;</span> <span class="ow">in</span> <span class="n">base_data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">sim_obsval_col_iloc</span> <span class="o">=</span> <span class="n">base_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;sim_obsval&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;sim_obsval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e30</span>
        <span class="n">sim_obsval_col_iloc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    
    <span class="k">for</span> <span class="n">site_no</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">values</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span>

        <span class="c1"># compute the differences</span>
        <span class="k">if</span> <span class="n">get_displacements</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">displacement_from</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            
            <span class="c1"># some sites may not have any measurements</span>
            <span class="c1"># after displacement datum; skip these</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">values</span><span class="p">[</span><span class="s1">&#39;obsval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">obs_values_col</span><span class="p">]</span> <span class="o">-</span> \
                <span class="n">values</span><span class="p">[</span><span class="n">obs_values_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">values</span><span class="p">[</span><span class="s1">&#39;sim_obsval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">sim_values_col</span><span class="p">]</span> <span class="o">-</span> \
                <span class="n">values</span><span class="p">[</span><span class="n">sim_values_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># assign np.nan to starting displacements (of 0) </span>
            <span class="c1"># (so they get dropped later on, </span>
            <span class="c1"># consistent with workflow for sequential difference obs)</span>
            <span class="n">values</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">obsval_col_iloc</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">values</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">sim_obsval_col_iloc</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="c1">#values[&#39;obsval&#39;].iloc[0] = np.nan</span>
            <span class="c1">#values[&#39;sim_obsval&#39;].iloc[0] = np.nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">values</span><span class="p">[</span><span class="s1">&#39;obsval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">obs_values_col</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>
            <span class="n">values</span><span class="p">[</span><span class="s1">&#39;sim_obsval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">sim_values_col</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span>

        <span class="c1"># name the temporal difference obs as</span>
        <span class="c1"># &lt;obsprefix&gt;_&lt;obsname1 suffix&gt;d&lt;obsname2 suffix&gt;</span>
        <span class="c1"># where the obsval = obsname2 - obsname1</span>
        <span class="n">obsnme</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
            <span class="n">obsname2_suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">get_displacements</span><span class="p">:</span>
                    <span class="n">obsname_2_loc</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">obsname_2_loc</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="c1"># date-based suffixes</span>
                <span class="k">if</span> <span class="n">obsnme_date_suffix</span><span class="p">:</span>
                    <span class="n">obsname2_suffix</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">obsname_2_loc</span><span class="p">]</span> \
                    <span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">obsnme_suffix_format</span><span class="p">)</span>
                <span class="c1"># stress period-based suffixes</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">per</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">obsname_2_loc</span><span class="p">][</span><span class="s1">&#39;per&#39;</span><span class="p">]</span>
                    <span class="n">obsname2_suffix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">per</span><span class="si">:{</span><span class="n">obsnme_suffix_format</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}}</span><span class="s2">&quot;</span>
            <span class="n">obsnme</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">d</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">obsnme</span><span class="p">,</span> <span class="n">obsname2_suffix</span><span class="p">))</span>
        <span class="n">values</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obsnme</span>

        <span class="c1"># todo: is there a general uncertainty approach for temporal differences that makes sense?</span>

        <span class="n">period_diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    
    <span class="n">period_diffs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">period_diffs</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># some checks to make sure the assignments from the above loop are correct</span>
    <span class="k">assert</span> <span class="n">period_diffs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">sim_obsval_col_iloc</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;sim_obsval&#39;</span>
    <span class="k">assert</span> <span class="n">period_diffs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">obsval_col_iloc</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;obsval&#39;</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">period_diffs</span><span class="p">[[</span><span class="s1">&#39;obsval&#39;</span><span class="p">,</span> <span class="s1">&#39;sim_obsval&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1e30</span><span class="p">)</span>
    
    <span class="n">period_diffs</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">period_diffs</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="s1">&#39;obgnme&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">period_diffs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">period_diffs</span><span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span>
    
    <span class="k">if</span> <span class="n">get_displacements</span><span class="p">:</span>
        <span class="n">period_diffs</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1"> displacement&#39;</span>
        <span class="n">period_diffs</span><span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g</span><span class="si">}</span><span class="s1">_disp&#39;</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">period_diffs</span><span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">period_diffs</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;temporal </span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1"> difference&#39;</span>
        <span class="n">period_diffs</span><span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g</span><span class="si">}</span><span class="s1">_tdiff&#39;</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">period_diffs</span><span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">]]</span>

    <span class="c1"># drop some columns that aren&#39;t really valid; if they exist</span>
    <span class="n">period_diffs</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;n&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

    <span class="c1"># clean up columns</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;per&#39;</span><span class="p">,</span> <span class="s1">&#39;obsprefix&#39;</span><span class="p">,</span> <span class="s1">&#39;obsnme&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;obs_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;sim_</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;screen_top&#39;</span><span class="p">,</span> <span class="s1">&#39;screen_botm&#39;</span><span class="p">,</span> <span class="s1">&#39;layer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;obsval&#39;</span><span class="p">,</span> <span class="s1">&#39;sim_obsval&#39;</span><span class="p">,</span> <span class="s1">&#39;obgnme&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">period_diffs</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">period_diffs</span> <span class="o">=</span> <span class="n">period_diffs</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># drop observations with no difference (first observations at each site)</span>
    <span class="n">period_diffs</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sim_obsval&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># drop any excluded obs</span>
    <span class="k">if</span> <span class="n">exclude_obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">exclude_obs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">exclude_obs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dropping </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">exclude_obs</span><span class="p">)</span><span class="si">}</span><span class="s2"> observations specified with exclude_obs&quot;</span><span class="p">)</span>
        <span class="n">period_diffs</span> <span class="o">=</span> <span class="n">period_diffs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">period_diffs</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">exclude_obs</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># fill NaT (not a time) datetimes</span>
    <span class="n">fill_nats</span><span class="p">(</span><span class="n">period_diffs</span><span class="p">,</span> <span class="n">perioddata</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">period_diffs</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mf">1e30</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;wrote </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">period_diffs</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1"> observations to </span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># write the instruction file</span>
        <span class="k">if</span> <span class="n">write_ins</span><span class="p">:</span>
            <span class="n">write_insfile</span><span class="p">(</span><span class="n">period_diffs</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.ins&#39;</span><span class="p">,</span>
                          <span class="n">obsnme_column</span><span class="o">=</span><span class="s1">&#39;obsnme&#39;</span><span class="p">,</span> <span class="n">simulated_obsval_column</span><span class="o">=</span><span class="s1">&#39;sim_obsval&#39;</span><span class="p">,</span>
                          <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">period_diffs</span></div>


<div class="viewcode-block" id="get_annual_means"><a class="viewcode-back" href="../../api/mfobs.obs.html#mfobs.obs.get_annual_means">[docs]</a><span class="k">def</span> <span class="nf">get_annual_means</span><span class="p">(</span><span class="n">base_data</span><span class="p">,</span> 
                     <span class="n">obsnme_suffix_format</span><span class="o">=</span><span class="s1">&#39;%Y&#39;</span><span class="p">,</span>
                     <span class="n">exclude_suffix</span><span class="o">=</span><span class="s1">&#39;ss&#39;</span><span class="p">,</span>
                     <span class="n">obgnme_suffix</span><span class="o">=</span><span class="s1">&#39;annual-mean&#39;</span><span class="p">,</span>
                     <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">write_ins</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create observations of annual mean values for a set of </span>
<span class="sd">    base observations. Means are computed for all columns with </span>
<span class="sd">    floating point data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    base_data : DataFrame</span>
<span class="sd">        Table of preprocessed observations, such as that produced by</span>
<span class="sd">        :func:`mfobs.obs.get_base_obs`. Must have the following columns,</span>
<span class="sd">        in addition to columns of floating point data to aggregate </span>
<span class="sd">        (which can have any name):</span>
<span class="sd">        </span>
<span class="sd">        =================== =============================================================</span>
<span class="sd">        datetime            pandas datetimes, based on stress period end date</span>
<span class="sd">        site_no             unique site identifier</span>
<span class="sd">        obsprefix\ :sup:`1` prefix of observation name</span>
<span class="sd">        obsnme              observation name based on format of &lt;obsprefix&gt;_&lt;suffix&gt;\ :sup:`2`</span>
<span class="sd">        obgnme              observation group name</span>

<span class="sd">        =================== =============================================================</span>
<span class="sd">        </span>
<span class="sd">        1) where obsprefix is assumed to be formatted as &lt;site_no&gt;-&lt;variable&gt; or simply &lt;site_no&gt;</span>
<span class="sd">        2) Assumed to be formatted &lt;obsprefix&gt;_&lt;`obsnme_suffix_format`&gt;</span>
<span class="sd">        </span>
<span class="sd">    obsnme_suffix_format : str, optional</span>
<span class="sd">        Format for suffix of obsnmes.</span>
<span class="sd">        By default &#39;%Y&#39;, which returns the 4-digit year</span>
<span class="sd">    exclude_suffix : str or list-like</span>
<span class="sd">        Option to exclude observations from differencing by suffix;</span>
<span class="sd">        e.g. &#39;ss&#39; to include steady-state observations.</span>
<span class="sd">        By default, &#39;ss&#39;</span>
<span class="sd">    obgnme_suffix : str</span>
<span class="sd">        Create new observation group names by appending this suffix to existing</span>
<span class="sd">        obgnmes, for example &lt;existing obgnme&gt;_&lt;obgnme_suffix&gt;</span>
<span class="sd">        by default, &#39;annual-mean&#39;</span>
<span class="sd">    outfile : str, optional</span>
<span class="sd">        CSV file to write output to.</span>
<span class="sd">        By default, None (no output written)</span>
<span class="sd">    write_ins : bool, optional</span>
<span class="sd">        Option to write instruction file, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    aggregated : DataFrame</span>
<span class="sd">        With the following columns (in addition to the data columns in `base_data`, </span>
<span class="sd">        which now contain the aggregated values):</span>
<span class="sd">        </span>
<span class="sd">        =================== =============================================================</span>
<span class="sd">        datetime            year of annual mean, as datetime</span>
<span class="sd">        year                year of annual mean, as integer</span>
<span class="sd">        site_no             unique site identifier</span>
<span class="sd">        obsprefix\ :sup:`1` prefix of observation name</span>
<span class="sd">        obsnme              observation name based on format of &lt;obsprefix&gt;_&lt;suffix&gt;\ :sup:`2`</span>
<span class="sd">        obgnme              observation group name\ :sup:`3`</span>

<span class="sd">        =================== =============================================================</span>
<span class="sd">        </span>
<span class="sd">        1) With format &lt;site_no&gt;-&lt;variable&gt; or simply &lt;site_no&gt; </span>
<span class="sd">        2) With suffix formatted with `obsnme_suffix_format`</span>
<span class="sd">        3) With format of &lt;original obgnme&gt;_&lt;obgnme_suffix&gt;</span>
<span class="sd">            e.g. heads_annual-mean</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># validation checks</span>
    <span class="c1">#obsnme_date_suffix=True</span>
    <span class="c1">#check_obsnme_suffix(obsnme_date_suffix, obsnme_suffix_format, </span>
    <span class="c1">#                    function_name=&#39;get_head_obs&#39;, obsdata=base_data)</span>
    <span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">])</span>
    
    <span class="c1"># only compute statistics on transient obs</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exclude_suffix</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">exclude_suffix</span> <span class="o">=</span> <span class="p">[</span><span class="n">exclude_suffix</span><span class="p">]</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="p">[</span><span class="n">obsnme</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">obsnme</span> <span class="ow">in</span> <span class="n">base_data</span><span class="o">.</span><span class="n">obsnme</span><span class="p">]</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">exclude_suffix</span><span class="p">)</span>
    <span class="n">base_data</span> <span class="o">=</span> <span class="n">base_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">grouped</span> <span class="o">=</span> <span class="n">base_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;site_no&#39;</span><span class="p">],</span> <span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">])</span>
    <span class="n">aggregated</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">data_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">base_data</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;float&#39;</span> <span class="ow">in</span> <span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data_cols</span><span class="p">:</span>
        <span class="n">aggregated</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">aggregated</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">set_names</span><span class="p">([</span><span class="s1">&#39;site_no&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">aggregated</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">aggregated</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;site_no&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">dt</span><span class="si">:{</span><span class="n">obsnme_suffix_format</span><span class="si">}}</span><span class="s2">&quot;</span> 
                            <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">dt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">],</span> 
                                                  <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">])]</span>
    <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">obgnme_suffix</span><span class="si">}</span><span class="s2">&quot;</span> 
                            <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">]]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;site_no&#39;</span><span class="p">,</span> <span class="s1">&#39;obsprefix&#39;</span><span class="p">,</span> <span class="s1">&#39;obsnme&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">data_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">]</span>
    <span class="n">aggregated</span> <span class="o">=</span> <span class="n">aggregated</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">aggregated</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mf">1e30</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;wrote </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">aggregated</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1"> observations to </span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># write the instruction file</span>
        <span class="k">if</span> <span class="n">write_ins</span><span class="p">:</span>
            <span class="n">write_insfile</span><span class="p">(</span><span class="n">aggregated</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.ins&#39;</span><span class="p">,</span>
                          <span class="n">obsnme_column</span><span class="o">=</span><span class="s1">&#39;obsnme&#39;</span><span class="p">,</span> <span class="n">simulated_obsval_column</span><span class="o">=</span><span class="s1">&#39;sim_obsval&#39;</span><span class="p">,</span>
                          <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aggregated</span></div>
    
    
<div class="viewcode-block" id="get_monthly_means"><a class="viewcode-back" href="../../api/mfobs.obs.html#mfobs.obs.get_monthly_means">[docs]</a><span class="k">def</span> <span class="nf">get_monthly_means</span><span class="p">(</span><span class="n">base_data</span><span class="p">,</span> 
                      <span class="n">obsnme_suffix_format</span><span class="o">=</span><span class="s1">&#39;%Y%m&#39;</span><span class="p">,</span>
                      <span class="n">exclude_suffix</span><span class="o">=</span><span class="s1">&#39;ss&#39;</span><span class="p">,</span>
                      <span class="n">obgnme_suffix</span><span class="o">=</span><span class="s1">&#39;monthly-mean&#39;</span><span class="p">,</span>
                      <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">write_ins</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create observations of monthly mean values for a set of </span>
<span class="sd">    base observations. Means are computed for all columns with </span>
<span class="sd">    floating point data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    base_data : DataFrame</span>
<span class="sd">        Table of preprocessed observations, such as that produced by</span>
<span class="sd">        :func:`mfobs.obs.get_base_obs`. Must have the following columns,</span>
<span class="sd">        in addition to columns of floating point data to aggregate </span>
<span class="sd">        (which can have any name):</span>
<span class="sd">        </span>
<span class="sd">        =================== =============================================================</span>
<span class="sd">        datetime            pandas datetimes, based on stress period end date</span>
<span class="sd">        site_no             unique site identifier</span>
<span class="sd">        obsprefix\ :sup:`1` prefix of observation name</span>
<span class="sd">        obsnme              observation name based on format of &lt;obsprefix&gt;_&lt;suffix&gt;\ :sup:`2`</span>
<span class="sd">        obgnme              observation group name</span>

<span class="sd">        =================== =============================================================</span>
<span class="sd">        </span>
<span class="sd">        1) where obsprefix is assumed to be formatted as &lt;site_no&gt;-&lt;variable&gt; or simply &lt;site_no&gt;</span>
<span class="sd">        2) Assumed to be formatted &lt;obsprefix&gt;_&lt;`obsnme_suffix_format`&gt;</span>
<span class="sd">        </span>
<span class="sd">    obsnme_suffix_format : str, optional</span>
<span class="sd">        Format for suffix of obsnmes.</span>
<span class="sd">        By default &#39;%Y%m&#39;, which returns the year and month as consecutive integers, </span>
<span class="sd">        e.g. 200101 for Jan, 2001.</span>
<span class="sd">    exclude_suffix : str or list-like</span>
<span class="sd">        Option to exclude observations from differencing by suffix;</span>
<span class="sd">        e.g. &#39;ss&#39; to include steady-state observations.</span>
<span class="sd">        By default, &#39;ss&#39;</span>
<span class="sd">    obgnme_suffix : str</span>
<span class="sd">        Create new observation group names by appending this suffix to existing</span>
<span class="sd">        obgnmes, for example &lt;existing obgnme&gt;_&lt;obgnme_suffix&gt;</span>
<span class="sd">        by default, &#39;annual-mean&#39;</span>
<span class="sd">    outfile : str, optional</span>
<span class="sd">        CSV file to write output to.</span>
<span class="sd">        By default, None (no output written)</span>
<span class="sd">    write_ins : bool, optional</span>
<span class="sd">        Option to write instruction file, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    aggregated : DataFrame</span>
<span class="sd">        With the following columns (in addition to the data columns in `base_data`, </span>
<span class="sd">        which now contain the aggregated values):</span>
<span class="sd">        </span>
<span class="sd">        =================== =============================================================</span>
<span class="sd">        datetime            aggregated dates as datetime objects</span>
<span class="sd">        site_no             unique site identifier</span>
<span class="sd">        obsprefix\ :sup:`1` prefix of observation name</span>
<span class="sd">        obsnme              observation name based on format of &lt;obsprefix&gt;_&lt;suffix&gt;\ :sup:`2`</span>
<span class="sd">        obgnme              observation group name\ :sup:`3`</span>

<span class="sd">        =================== =============================================================</span>
<span class="sd">        </span>
<span class="sd">        1) With format &lt;site_no&gt;-&lt;variable&gt; or simply &lt;site_no&gt; </span>
<span class="sd">        2) With suffix formatted with `obsnme_suffix_format`</span>
<span class="sd">        3) With format of &lt;original obgnme&gt;_&lt;obgnme_suffix&gt;</span>
<span class="sd">            e.g. heads_annual-mean</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># validation checks</span>
    <span class="c1">#obsnme_date_suffix=True</span>
    <span class="c1">#check_obsnme_suffix(obsnme_date_suffix, obsnme_suffix_format, </span>
    <span class="c1">#                    function_name=&#39;get_head_obs&#39;, obsdata=base_data)</span>
    <span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">])</span>
    
    <span class="c1"># only compute statistics on transient obs</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exclude_suffix</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">exclude_suffix</span> <span class="o">=</span> <span class="p">[</span><span class="n">exclude_suffix</span><span class="p">]</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="p">[</span><span class="n">obsnme</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">obsnme</span> <span class="ow">in</span> <span class="n">base_data</span><span class="o">.</span><span class="n">obsnme</span><span class="p">]</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">exclude_suffix</span><span class="p">)</span>
    <span class="n">base_data</span> <span class="o">=</span> <span class="n">base_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">grouped</span> <span class="o">=</span> <span class="n">base_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;site_no&#39;</span><span class="p">],</span>
                                 <span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> 
                                 <span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">])</span>
    <span class="n">aggregated</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">data_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">base_data</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;float&#39;</span> <span class="ow">in</span> <span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data_cols</span><span class="p">:</span>
        <span class="n">aggregated</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">aggregated</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">set_names</span><span class="p">([</span><span class="s1">&#39;site_no&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">aggregated</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">aggregated</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;site_no&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">dt</span><span class="si">:{</span><span class="n">obsnme_suffix_format</span><span class="si">}}</span><span class="s2">&quot;</span> 
                            <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">dt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">],</span> 
                                                  <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">])]</span>
    <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">obgnme_suffix</span><span class="si">}</span><span class="s2">&quot;</span> 
                            <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">]]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;site_no&#39;</span><span class="p">,</span> <span class="s1">&#39;obsprefix&#39;</span><span class="p">,</span> <span class="s1">&#39;obsnme&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">data_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">]</span>
    <span class="n">aggregated</span> <span class="o">=</span> <span class="n">aggregated</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">aggregated</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mf">1e30</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;wrote </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">aggregated</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1"> observations to </span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># write the instruction file</span>
        <span class="k">if</span> <span class="n">write_ins</span><span class="p">:</span>
            <span class="n">write_insfile</span><span class="p">(</span><span class="n">aggregated</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.ins&#39;</span><span class="p">,</span>
                          <span class="n">obsnme_column</span><span class="o">=</span><span class="s1">&#39;obsnme&#39;</span><span class="p">,</span> <span class="n">simulated_obsval_column</span><span class="o">=</span><span class="s1">&#39;sim_obsval&#39;</span><span class="p">,</span>
                          <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aggregated</span></div>


<div class="viewcode-block" id="get_mean_monthly"><a class="viewcode-back" href="../../api/mfobs.obs.html#mfobs.obs.get_mean_monthly">[docs]</a><span class="k">def</span> <span class="nf">get_mean_monthly</span><span class="p">(</span><span class="n">base_data</span><span class="p">,</span> 
                     <span class="n">obsnme_suffix_format</span><span class="o">=</span><span class="s1">&#39;%b&#39;</span><span class="p">,</span>
                     <span class="n">exclude_suffix</span><span class="o">=</span><span class="s1">&#39;ss&#39;</span><span class="p">,</span>
                     <span class="n">obgnme_suffix</span><span class="o">=</span><span class="s1">&#39;mean-monthly&#39;</span><span class="p">,</span>
                     <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">write_ins</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create observations of mean monthly, or means for months of the year</span>
<span class="sd">    (for example, the mean for Jan. across all years). Means are computed for </span>
<span class="sd">    all columns with floating point data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    base_data : DataFrame</span>
<span class="sd">        Table of preprocessed observations, such as that produced by</span>
<span class="sd">        :func:`mfobs.obs.get_base_obs`. Must have the following columns,</span>
<span class="sd">        in addition to columns of floating point data to aggregate </span>
<span class="sd">        (which can have any name):</span>
<span class="sd">        </span>
<span class="sd">        =================== =============================================================</span>
<span class="sd">        datetime            pandas datetimes, based on stress period end date</span>
<span class="sd">        site_no             unique site identifier</span>
<span class="sd">        obsprefix\ :sup:`1` prefix of observation name</span>
<span class="sd">        obsnme              observation name based on format of &lt;obsprefix&gt;_&lt;suffix&gt;\ :sup:`2`</span>
<span class="sd">        obgnme              observation group name</span>

<span class="sd">        =================== =============================================================</span>
<span class="sd">        </span>
<span class="sd">        1) where obsprefix is assumed to be formatted as &lt;site_no&gt;-&lt;variable&gt; or simply &lt;site_no&gt;</span>
<span class="sd">        2) Assumed to be formatted &lt;obsprefix&gt;_&lt;`obsnme_suffix_format`&gt;</span>
<span class="sd">        </span>
<span class="sd">    obsnme_suffix_format : str, optional</span>
<span class="sd">        Format for suffix of obsnmes.</span>
<span class="sd">        By default &#39;%b&#39;, which returns the abbreviated month name (e.g. &#39;Jan&#39;).</span>
<span class="sd">    exclude_suffix : str or list-like</span>
<span class="sd">        Option to exclude observations from differencing by suffix;</span>
<span class="sd">        e.g. &#39;ss&#39; to include steady-state observations.</span>
<span class="sd">        By default, &#39;ss&#39;</span>
<span class="sd">    obgnme_suffix : str</span>
<span class="sd">        Create new observation group names by appending this suffix to existing</span>
<span class="sd">        obgnmes, for example &lt;existing obgnme&gt;_&lt;obgnme_suffix&gt;</span>
<span class="sd">        by default, &#39;annual-mean&#39;</span>
<span class="sd">    outfile : str, optional</span>
<span class="sd">        CSV file to write output to.</span>
<span class="sd">        By default, None (no output written)</span>
<span class="sd">    write_ins : bool, optional</span>
<span class="sd">        Option to write instruction file, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    aggregated : DataFrame</span>
<span class="sd">        With the following columns (in addition to the data columns in `base_data`, </span>
<span class="sd">        which now contain the aggregated values):</span>
<span class="sd">        </span>
<span class="sd">        =================== =============================================================</span>
<span class="sd">        datetime            datetimes that represent the mean of the period averaged</span>
<span class="sd">        month               month of monthly average values</span>
<span class="sd">        site_no             unique site identifier</span>
<span class="sd">        obsprefix\ :sup:`1` prefix of observation name</span>
<span class="sd">        obsnme              observation name based on format of &lt;obsprefix&gt;_&lt;suffix&gt;\ :sup:`2`</span>
<span class="sd">        obgnme              observation group name\ :sup:`3`</span>

<span class="sd">        =================== =============================================================</span>
<span class="sd">        </span>
<span class="sd">        1) With format &lt;site_no&gt;-&lt;variable&gt; or simply &lt;site_no&gt; </span>
<span class="sd">        2) With suffix formatted with `obsnme_suffix_format`</span>
<span class="sd">        3) With format of &lt;original obgnme&gt;_&lt;obgnme_suffix&gt;</span>
<span class="sd">            e.g. heads_annual-mean</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># validation checks</span>
    <span class="c1">#obsnme_date_suffix=True,</span>
    <span class="c1">#check_obsnme_suffix(obsnme_date_suffix, obsnme_suffix_format, </span>
    <span class="c1">#                    function_name=&#39;get_head_obs&#39;, obsdata=base_data)</span>
    <span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">])</span>
    
    <span class="c1"># only compute statistics on transient obs</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exclude_suffix</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">exclude_suffix</span> <span class="o">=</span> <span class="p">[</span><span class="n">exclude_suffix</span><span class="p">]</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="p">[</span><span class="n">obsnme</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">obsnme</span> <span class="ow">in</span> <span class="n">base_data</span><span class="o">.</span><span class="n">obsnme</span><span class="p">]</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">exclude_suffix</span><span class="p">)</span>
    <span class="n">base_data</span> <span class="o">=</span> <span class="n">base_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">grouped</span> <span class="o">=</span> <span class="n">base_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;site_no&#39;</span><span class="p">],</span>
                                 <span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">])</span>
    <span class="n">aggregated</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">data_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">base_data</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;float&#39;</span> <span class="ow">in</span> <span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data_cols</span><span class="p">:</span>
        <span class="n">aggregated</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">aggregated</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">set_names</span><span class="p">([</span><span class="s1">&#39;site_no&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">aggregated</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">aggregated</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;site_no&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># change month column to be name instead of number</span>
    <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dt</span><span class="si">:</span><span class="s2">%B</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]]</span>
        
    <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">dt</span><span class="si">:{</span><span class="n">obsnme_suffix_format</span><span class="si">}}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> 
                            <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">dt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">],</span> 
                                                  <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">])]</span>
    <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">obgnme_suffix</span><span class="si">}</span><span class="s2">&quot;</span> 
                            <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">]]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;site_no&#39;</span><span class="p">,</span> <span class="s1">&#39;obsprefix&#39;</span><span class="p">,</span> <span class="s1">&#39;obsnme&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">data_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">]</span>
    <span class="n">aggregated</span> <span class="o">=</span> <span class="n">aggregated</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">aggregated</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mf">1e30</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;wrote </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">aggregated</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1"> observations to </span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># write the instruction file</span>
        <span class="k">if</span> <span class="n">write_ins</span><span class="p">:</span>
            <span class="n">write_insfile</span><span class="p">(</span><span class="n">aggregated</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.ins&#39;</span><span class="p">,</span>
                          <span class="n">obsnme_column</span><span class="o">=</span><span class="s1">&#39;obsnme&#39;</span><span class="p">,</span> <span class="n">simulated_obsval_column</span><span class="o">=</span><span class="s1">&#39;sim_obsval&#39;</span><span class="p">,</span>
                          <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aggregated</span></div>
    

<div class="viewcode-block" id="get_log10_observations"><a class="viewcode-back" href="../../api/mfobs.obs.html#mfobs.obs.get_log10_observations">[docs]</a><span class="k">def</span> <span class="nf">get_log10_observations</span><span class="p">(</span><span class="n">base_data</span><span class="p">,</span> 
                           <span class="n">obsnme_suffix_format</span><span class="o">=</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-log&#39;</span><span class="p">,</span>
                           <span class="n">exclude_suffix</span><span class="o">=</span><span class="s1">&#39;ss&#39;</span><span class="p">,</span>
                           <span class="n">obgnme_suffix</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span>
                           <span class="n">fill_zeros_with</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">write_ins</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create observations of log values. Log values are computed for </span>
<span class="sd">    all columns with floating point data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    base_data : DataFrame</span>
<span class="sd">        Table of preprocessed observations, such as that produced by</span>
<span class="sd">        :func:`mfobs.obs.get_base_obs`. Must have the following columns,</span>
<span class="sd">        in addition to columns of floating point data to aggregate </span>
<span class="sd">        (which can have any name):</span>
<span class="sd">        </span>
<span class="sd">        =================== =============================================================</span>
<span class="sd">        datetime            pandas datetimes, based on stress period end date</span>
<span class="sd">        site_no             unique site identifier</span>
<span class="sd">        obsprefix\ :sup:`1` prefix of observation name</span>
<span class="sd">        obsnme              observation name based on format of &lt;obsprefix&gt;_&lt;suffix&gt;\ :sup:`2`</span>
<span class="sd">        obgnme              observation group name</span>

<span class="sd">        =================== =============================================================</span>
<span class="sd">        </span>
<span class="sd">        1) where obsprefix is assumed to be formatted as &lt;site_no&gt;-&lt;variable&gt; or simply &lt;site_no&gt;</span>
<span class="sd">        2) Assumed to be formatted &lt;obsprefix&gt;_&lt;`obsnme_suffix_format`&gt;</span>
<span class="sd">        </span>
<span class="sd">    obsnme_suffix_format : str, optional</span>
<span class="sd">        Format for suffix of obsnmes.</span>
<span class="sd">        By default &#39;&#39;%Y%m%d-log&#39; (e.g. 20010101-log for Jan 1, 2001)</span>
<span class="sd">    exclude_suffix : str or list-like</span>
<span class="sd">        Option to exclude observations from differencing by suffix;</span>
<span class="sd">        e.g. &#39;ss&#39; to include steady-state observations.</span>
<span class="sd">        By default, &#39;ss&#39;</span>
<span class="sd">    obgnme_suffix : str</span>
<span class="sd">        Create new observation group names by appending this suffix to existing</span>
<span class="sd">        obgnmes, for example &lt;existing obgnme&gt;_&lt;obgnme_suffix&gt;</span>
<span class="sd">        by default, &#39;annual-mean&#39;</span>
<span class="sd">    fill_zeros_with : numeric</span>
<span class="sd">        Fill value in log data for zero values in base_data.</span>
<span class="sd">    outfile : str, optional</span>
<span class="sd">        CSV file to write output to.</span>
<span class="sd">        By default, None (no output written)</span>
<span class="sd">    write_ins : bool, optional</span>
<span class="sd">        Option to write instruction file, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    log_base_data : DataFrame</span>
<span class="sd">        With the following columns (in addition to the data columns in `base_data`, </span>
<span class="sd">        which now contain the aggregated values):</span>
<span class="sd">        </span>
<span class="sd">        =================== =============================================================</span>
<span class="sd">        datetime            observation dates as datetimes</span>
<span class="sd">        site_no             unique site identifier</span>
<span class="sd">        obsprefix\ :sup:`1` prefix of observation name</span>
<span class="sd">        obsnme              observation name based on format of &lt;obsprefix&gt;_&lt;suffix&gt;\ :sup:`2`</span>
<span class="sd">        obgnme              observation group name\ :sup:`3`</span>

<span class="sd">        =================== =============================================================</span>
<span class="sd">        </span>
<span class="sd">        1) With format &lt;site_no&gt;-&lt;variable&gt; or simply &lt;site_no&gt; </span>
<span class="sd">        2) With suffix formatted with `obsnme_suffix_format`</span>
<span class="sd">        3) With format of &lt;original obgnme&gt;_&lt;obgnme_suffix&gt;</span>
<span class="sd">            e.g. heads_annual-mean</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">])</span>
    
    <span class="c1"># only compute statistics on transient obs</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exclude_suffix</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">exclude_suffix</span> <span class="o">=</span> <span class="p">[</span><span class="n">exclude_suffix</span><span class="p">]</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="p">[</span><span class="n">obsnme</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">obsnme</span> <span class="ow">in</span> <span class="n">base_data</span><span class="o">.</span><span class="n">obsnme</span><span class="p">]</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">exclude_suffix</span><span class="p">)</span>
    <span class="n">base_data</span> <span class="o">=</span> <span class="n">base_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">log_base_data</span> <span class="o">=</span> <span class="n">base_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">base_data</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;float&#39;</span> <span class="ow">in</span> <span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data_cols</span><span class="p">:</span>
        <span class="n">log_base_data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">base_data</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
        <span class="n">log_base_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">base_data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill_zeros_with</span> <span class="c1"># handle zero values</span>
        
    <span class="n">log_base_data</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">dt</span><span class="si">:{</span><span class="n">obsnme_suffix_format</span><span class="si">}}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> 
                            <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">dt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">log_base_data</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">],</span> 
                                                  <span class="n">log_base_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">])]</span>
    <span class="n">log_base_data</span><span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">obgnme_suffix</span><span class="si">}</span><span class="s2">&quot;</span> 
                            <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">log_base_data</span><span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">]]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;site_no&#39;</span><span class="p">,</span> <span class="s1">&#39;obsprefix&#39;</span><span class="p">,</span> <span class="s1">&#39;obsnme&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">data_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">]</span>
    <span class="n">log_base_data</span> <span class="o">=</span> <span class="n">log_base_data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_base_data</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mf">1e30</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;wrote </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">log_base_data</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1"> observations to </span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># write the instruction file</span>
        <span class="k">if</span> <span class="n">write_ins</span><span class="p">:</span>
            <span class="n">write_insfile</span><span class="p">(</span><span class="n">log_base_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.ins&#39;</span><span class="p">,</span>
                          <span class="n">obsnme_column</span><span class="o">=</span><span class="s1">&#39;obsnme&#39;</span><span class="p">,</span> <span class="n">simulated_obsval_column</span><span class="o">=</span><span class="s1">&#39;sim_obsval&#39;</span><span class="p">,</span>
                          <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">log_base_data</span></div>
    

<div class="viewcode-block" id="get_baseflow_observations"><a class="viewcode-back" href="../../api/mfobs.obs.html#mfobs.obs.get_baseflow_observations">[docs]</a><span class="k">def</span> <span class="nf">get_baseflow_observations</span><span class="p">(</span><span class="n">base_data</span><span class="p">,</span> 
                              <span class="n">obsnme_suffix_format</span><span class="o">=</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-bf&#39;</span><span class="p">,</span>
                              <span class="n">exclude_suffix</span><span class="o">=</span><span class="s1">&#39;ss&#39;</span><span class="p">,</span>
                              <span class="n">obgnme_suffix</span><span class="o">=</span><span class="s1">&#39;bf&#39;</span><span class="p">,</span>
                              <span class="n">missing_obs_fill_value</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                              <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">write_ins</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create observations of base flow using the </span>
<span class="sd">    BFI/Institute of Hydrology hydrograph separation method (:func:`mfobs.sep.ih_method`).</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    base_data : DataFrame</span>
<span class="sd">        Table of preprocessed observations, such as that produced by</span>
<span class="sd">        :func:`mfobs.obs.get_base_obs`. Must have the following columns,</span>
<span class="sd">        in addition to columns of floating point data to aggregate </span>
<span class="sd">        (which can have any name):</span>
<span class="sd">        </span>
<span class="sd">        =================== =============================================================</span>
<span class="sd">        datetime            pandas datetimes, based on stress period end date</span>
<span class="sd">        site_no             unique site identifier</span>
<span class="sd">        obsprefix\ :sup:`1` prefix of observation name</span>
<span class="sd">        obsnme              observation name based on format of &lt;obsprefix&gt;_&lt;suffix&gt;\ :sup:`2`</span>
<span class="sd">        obgnme              observation group name</span>

<span class="sd">        =================== =============================================================</span>
<span class="sd">        </span>
<span class="sd">        1) where obsprefix is assumed to be formatted as &lt;site_no&gt;-&lt;variable&gt; or simply &lt;site_no&gt;</span>
<span class="sd">        2) Assumed to be formatted &lt;obsprefix&gt;_&lt;`obsnme_suffix_format`&gt;</span>
<span class="sd">        </span>
<span class="sd">    obsnme_suffix_format : str, optional</span>
<span class="sd">        Format for suffix of obsnmes.</span>
<span class="sd">        By default &#39;&#39;%Y%m%d-log&#39; (e.g. 20010101-log for Jan 1, 2001)</span>
<span class="sd">    exclude_suffix : str or list-like</span>
<span class="sd">        Option to exclude observations from differencing by suffix;</span>
<span class="sd">        e.g. &#39;ss&#39; to include steady-state observations.</span>
<span class="sd">        By default, &#39;ss&#39;</span>
<span class="sd">    obgnme_suffix : str</span>
<span class="sd">        Create new observation group names by appending this suffix to existing</span>
<span class="sd">        obgnmes, for example &lt;existing obgnme&gt;_&lt;obgnme_suffix&gt;</span>
<span class="sd">        by default, &#39;annual-mean&#39;</span>
<span class="sd">    missing_obs_fill_value : float</span>
<span class="sd">        Baseflow observations are different from most other observation types in that</span>
<span class="sd">        they are produced by hydrograph separation, which can lead to different numbers</span>
<span class="sd">        of observations with changing conditions. For example, a given parameter set</span>
<span class="sd">        may produce a total flow hydrograph with a different number of ordinates (turning points),</span>
<span class="sd">        which in turn can change the interpolation of baseflow values between ordinates, potentially</span>
<span class="sd">        producing either &#39;extra&#39; observations (not in the instruction file) or missing observations.</span>
<span class="sd">        Missing observations will be filled with `missing_obs_value`, so that PEST doesn&#39;t crash. A</span>
<span class="sd">        value of 0. is recommended, as missing observations are often associated with low or no-flow</span>
<span class="sd">        periods, especially near the start or end of a timeseries.</span>
<span class="sd">    outfile : str, optional</span>
<span class="sd">        CSV file to write output to.</span>
<span class="sd">        By default, None (no output written)</span>
<span class="sd">    write_ins : bool, optional</span>
<span class="sd">        Option to write instruction file, by default False</span>
<span class="sd">    **kwargs : key-word arguments to :func:`mfobs.sep.ih_method`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bf_base_data : DataFrame</span>
<span class="sd">        With the following columns (in addition to the data columns in `base_data`, </span>
<span class="sd">        which now contain the aggregated values):</span>
<span class="sd">        </span>
<span class="sd">        =================== =============================================================</span>
<span class="sd">        datetime            observation dates as datetimes</span>
<span class="sd">        site_no             unique site identifier</span>
<span class="sd">        obsprefix\ :sup:`1` prefix of observation name</span>
<span class="sd">        obsnme              observation name based on format of &lt;obsprefix&gt;_&lt;suffix&gt;\ :sup:`2`</span>
<span class="sd">        obgnme              observation group name\ :sup:`3`</span>

<span class="sd">        =================== =============================================================</span>
<span class="sd">        </span>
<span class="sd">        1) With format &lt;site_no&gt;-&lt;variable&gt; or simply &lt;site_no&gt; </span>
<span class="sd">        2) With suffix formatted with `obsnme_suffix_format`</span>
<span class="sd">        3) With format of &lt;original obgnme&gt;_&lt;obgnme_suffix&gt;</span>
<span class="sd">            e.g. heads_annual-mean</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">base_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">])</span>
    
    <span class="c1"># only compute statistics on transient obs</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exclude_suffix</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">exclude_suffix</span> <span class="o">=</span> <span class="p">[</span><span class="n">exclude_suffix</span><span class="p">]</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="p">[</span><span class="n">obsnme</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">obsnme</span> <span class="ow">in</span> <span class="n">base_data</span><span class="o">.</span><span class="n">obsnme</span><span class="p">]</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">exclude_suffix</span><span class="p">)</span>
    <span class="n">base_data</span> <span class="o">=</span> <span class="n">base_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">bf_base_data</span> <span class="o">=</span> <span class="n">base_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">data_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">base_data</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;float&#39;</span> <span class="ow">in</span> <span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="n">bf_base_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">bf_base_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">])</span>
    
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">site_groups</span> <span class="o">=</span> <span class="n">bf_base_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">obsprefix</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">site_groups</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data_cols</span><span class="p">:</span>
            <span class="c1"># series must be at least 2x the BFI block length (default=5)</span>
            <span class="n">block_length</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;block_length&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">block_length</span> <span class="o">*</span> <span class="mi">2</span><span class="p">):</span>            
                <span class="n">results</span> <span class="o">=</span> <span class="n">ih_method</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">group</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;QB&#39;</span><span class="p">]</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
    <span class="n">bf_base_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>

    <span class="c1"># drop nan values</span>
    <span class="n">bf_base_data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;obsval&#39;</span><span class="p">,</span> <span class="s1">&#39;sim_obsval&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">bf_base_data</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">dt</span><span class="si">:{</span><span class="n">obsnme_suffix_format</span><span class="si">}}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> 
                            <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">dt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bf_base_data</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">],</span> 
                                                  <span class="n">bf_base_data</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">])]</span>
    <span class="n">bf_base_data</span><span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">obgnme_suffix</span><span class="si">}</span><span class="s2">&quot;</span> 
                            <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">bf_base_data</span><span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">]]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;site_no&#39;</span><span class="p">,</span> <span class="s1">&#39;obsprefix&#39;</span><span class="p">,</span> <span class="s1">&#39;obsnme&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">data_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;obgnme&#39;</span><span class="p">]</span>
    <span class="n">bf_base_data</span> <span class="o">=</span> <span class="n">bf_base_data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># write the instruction file</span>
        <span class="k">if</span> <span class="n">write_ins</span><span class="p">:</span>
            <span class="n">write_insfile</span><span class="p">(</span><span class="n">bf_base_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.ins&#39;</span><span class="p">,</span>
                          <span class="n">obsnme_column</span><span class="o">=</span><span class="s1">&#39;obsnme&#39;</span><span class="p">,</span> <span class="n">simulated_obsval_column</span><span class="o">=</span><span class="s1">&#39;sim_obsval&#39;</span><span class="p">,</span>
                          <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># otherwise, normalize observations to the instruction file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">insfile_obs</span> <span class="o">=</span> <span class="n">get_insfile_observations</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.ins&#39;</span><span class="p">)</span>
            
            <span class="n">missing_in_output</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">insfile_obs</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">bf_base_data</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">])</span>
            <span class="n">extra_in_output</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">bf_base_data</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">insfile_obs</span><span class="p">)</span>
            
            <span class="c1"># fill missing observations</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">missing_in_output</span><span class="p">):</span>
                <span class="n">bf_base_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">bf_base_data</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">]</span>
                
                <span class="c1"># re-index the observation data to add rows for the missing obs</span>
                <span class="n">reindexed</span> <span class="o">=</span> <span class="n">bf_base_data</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">insfile_obs</span><span class="p">)</span>
                <span class="c1"># identify rows containing missing obs</span>
                <span class="n">filled</span> <span class="o">=</span> <span class="n">reindexed</span><span class="p">[</span><span class="s1">&#39;sim_obsval&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
                <span class="c1"># refill columns for the missing obs</span>
                <span class="n">reindexed</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reindexed</span><span class="o">.</span><span class="n">index</span>
                <span class="n">reindexed</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filled</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                                                     <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">reindexed</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filled</span><span class="p">,</span> <span class="s1">&#39;obsnme&#39;</span><span class="p">]]</span>
                <span class="n">reindexed</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filled</span><span class="p">,</span> <span class="s1">&#39;site_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">reindexed</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filled</span><span class="p">,</span> <span class="s1">&#39;obsnme&#39;</span><span class="p">]]</span>
                <span class="n">reindexed</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filled</span><span class="p">,</span> <span class="s1">&#39;obsprefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">reindexed</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filled</span><span class="p">,</span> <span class="s1">&#39;obsnme&#39;</span><span class="p">]]</span>
                <span class="n">reindexed</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filled</span><span class="p">,</span> <span class="s1">&#39;obgnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;filled-bf&#39;</span>
                <span class="n">reindexed</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">filled</span><span class="p">,</span> <span class="n">data_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_obs_fill_value</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">reindexed</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
                <span class="n">bf_base_data</span> <span class="o">=</span> <span class="n">reindexed</span>
            <span class="c1"># drop any extra observations</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">extra_in_output</span><span class="p">):</span>
                <span class="n">bf_base_data</span> <span class="o">=</span> <span class="n">bf_base_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">bf_base_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">extra_in_output</span><span class="p">)]</span>
            
        <span class="n">bf_base_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;wrote </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bf_base_data</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1"> observations to </span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">bf_base_data</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
      <span class="lastupdated">Last updated on Oct 02, 2023.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>