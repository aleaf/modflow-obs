

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mfobs.modflow &mdash; modflow-obs 0.post92.dev0+ga6ecc46 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=f03adc21"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            modflow-obs
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../philosophy.html">Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../10minutes.html">10 minutes to PEST observations</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Example.html"> Demo of Modflow-obs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Code reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html"> Modules</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Release history</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../release-history.html"> Release History</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing to modflow-obs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Bibliography</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../references.html">References cited</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../references.html#published-applications-of-modflow-obs">Published applications of Modflow-obs</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">modflow-obs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">mfobs.modflow</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mfobs.modflow</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Functions specific to MODFLOW and flopy</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">affine</span> <span class="kn">import</span> <span class="n">Affine</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">flopy</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">flopy</span> <span class="o">=</span> <span class="kc">False</span>
<span class="kn">from</span> <span class="nn">mfobs.utils</span> <span class="kn">import</span> <span class="n">set_period_start_end_dates</span>
<span class="kn">from</span> <span class="nn">mfobs.fileio</span> <span class="kn">import</span> <span class="n">write_insfile</span><span class="p">,</span> <span class="n">read_csv</span>
<span class="kn">from</span> <span class="nn">mfobs.utils</span> <span class="kn">import</span> <span class="n">set_period_start_end_dates</span>


<span class="n">itmuni_text</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;undefined&quot;</span><span class="p">,</span>
               <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;seconds&quot;</span><span class="p">,</span>
               <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;minutes&quot;</span><span class="p">,</span>
               <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;hours&quot;</span><span class="p">,</span>
               <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;days&quot;</span><span class="p">,</span>
               <span class="mi">5</span><span class="p">:</span> <span class="s2">&quot;years&quot;</span>
                 <span class="p">}</span>

<div class="viewcode-block" id="get_gwf_obs_input">
<a class="viewcode-back" href="../../api/mfobs.modflow.html#mfobs.modflow.get_gwf_obs_input">[docs]</a>
<span class="k">def</span> <span class="nf">get_gwf_obs_input</span><span class="p">(</span><span class="n">gwf_obs_input_file</span><span class="p">,</span> <span class="n">gwf_obs_block</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the first BEGIN continuous  FILEOUT block of an input</span>
<span class="sd">    file to the MODFLOW-6 GWF observation utility.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gwf_obs_input_file : str</span>
<span class="sd">        Input file to MODFLOW-6 observation utility (contains layer information).</span>
<span class="sd">    gwf_obs_block : None or int</span>
<span class="sd">        Optional argument to read a specific observation block or all blocks </span>
<span class="sd">        from GWF observation utility file. Value of None returns observations </span>
<span class="sd">        from all blocks. Integer value returns obs from a specifc block, in </span>
<span class="sd">        (zero-based) order from top to bottom. For example, a value of 0 would </span>
<span class="sd">        return the first obs block, value of 1 would return the second obs </span>
<span class="sd">        block, and so on.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Modflow-setup writes all of the observation input to a single block, but </span>
<span class="sd">    observation input can be broken out into multiple blocks (one per file).</span>

<span class="sd">    This also doesn&#39;t work with open/close statements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">gwf_obs_block</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">gwf_obs_input_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;BEGIN continuous&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="c1"># read whole file with pandas.read_csv</span>
                    <span class="c1"># skipping over any lines that can&#39;t be read</span>
                    <span class="c1"># (MODFLOW 6 block headers and footers)</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">s+&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="n">on_bad_lines</span><span class="o">=</span><span class="s1">&#39;skip&#39;</span><span class="p">)</span>
                    <span class="c1"># remove the MODFLOW 6 block headers and footers</span>
                    <span class="c1"># if they were included in the dataframe</span>
                    <span class="n">bad_lines</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">bad_lines</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="c1"># enfore ints for index values</span>
                    <span class="c1"># (pandas will cast to float if there are nans)</span>
                    <span class="n">df</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nan values in </span><span class="si">{</span><span class="n">gwf_obs_input_file</span><span class="si">}</span><span class="s2">; check input.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gwf_obs_block</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>    
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">gwf_obs_input_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">begin_idxs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">end_idxs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;BEGIN continuous&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">begin_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;END continuous&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">end_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">gwf_obs_input_file</span><span class="p">,</span> 
                         <span class="n">skiprows</span><span class="o">=</span><span class="n">begin_idxs</span><span class="p">[</span><span class="n">gwf_obs_block</span><span class="p">],</span>
                         <span class="n">skipfooter</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">end_idxs</span><span class="p">[</span><span class="n">gwf_obs_block</span><span class="p">]),</span>
                         <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">s+&#39;</span><span class="p">,</span> 
                         <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span>
                         <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;gwf_obs_block must be &#39;None&#39; or an integer&quot;</span><span class="p">)</span>

    <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;obsname&#39;</span><span class="p">,</span> <span class="s1">&#39;obstype&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">index_col</span> <span class="ow">in</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">index_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">index_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="get_ij">
<a class="viewcode-back" href="../../api/mfobs.modflow.html#mfobs.modflow.get_ij">[docs]</a>
<span class="k">def</span> <span class="nf">get_ij</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the row and column of a point or sequence of points</span>
<span class="sd">    in real-world coordinates. Uses the affine package. Basically,</span>

<span class="sd">    * to get an x, y: transform * (col, row)</span>
<span class="sd">    * the inverse, ~transform * (x, y) returns a fractional i, j location on the grid</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    transform : affine.Affine instance</span>
<span class="sd">        An `affine.Affine &lt;https://github.com/sgillies/affine&gt;`_ object describing the orientation</span>
<span class="sd">        of the model grid. Modflow-setup :class:`~mfsetup.grid.MFsetupGrid` have this attached</span>
<span class="sd">        via the :meth:`~mfsetup.grid.MFsetupGrid.transform` property. Example::</span>

<span class="sd">            modelgrid_transform=affine.Affine(1000.0, 0.0, 500955,</span>
<span class="sd">                                              0.0, -1000.0, 1205285)</span>

<span class="sd">        for a uniform spacing of 1000 and upper left corner of 500955, 1205285</span>
<span class="sd">        with a rotation of 45 degrees, counter-clockwise about the upper left corner::</span>

<span class="sd">            modelgrid_transform=affine.Affine(1000.0, 0.0, 500955,</span>
<span class="sd">                                              0.0, -1000.0, 1205285).rotation(45.)</span>

<span class="sd">        An ``affine.Affine`` instance can also be created from a</span>
<span class="sd">        `Modflow-setup &lt;https://github.com/aleaf/modflow-setup&gt;`_</span>
<span class="sd">        grid JSON file via the :func:`~mfobs.modflow.get_modelgrid_transform` function.</span>

<span class="sd">    x : scalar or sequence of x coordinates</span>
<span class="sd">    y : scalar or sequence of y coordinates</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    i : row or sequence of rows (zero-based)</span>
<span class="sd">    j : column or sequence of columns (zero-based)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">j</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="o">~</span><span class="n">transform</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="c1"># decrement so that points within a cell (pixel)</span>
    <span class="c1"># round to the cell center</span>
    <span class="c1"># (transform returns fractional row/column positions </span>
    <span class="c1"># relative to the upper left corner)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span></div>



<div class="viewcode-block" id="get_kstp_kper">
<a class="viewcode-back" href="../../api/mfobs.modflow.html#mfobs.modflow.get_kstp_kper">[docs]</a>
<span class="k">def</span> <span class="nf">get_kstp_kper</span><span class="p">(</span><span class="n">nstp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a sequence of the number of timesteps in each stress period,</span>
<span class="sd">    return a sequence of timestep, period tuples (kstp, kper) used</span>
<span class="sd">    by various flopy methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kstp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">kper</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nstp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nstp</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nstp</span><span class="p">):</span>
            <span class="n">kstp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">kper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kstp</span><span class="p">,</span> <span class="n">kper</span></div>



<div class="viewcode-block" id="get_layer">
<a class="viewcode-back" href="../../api/mfobs.modflow.html#mfobs.modflow.get_layer">[docs]</a>
<span class="k">def</span> <span class="nf">get_layer</span><span class="p">(</span><span class="n">column_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pandas appends duplicate column names with a .*,</span>
<span class="sd">    where * is the number of duplicate names from left to right</span>
<span class="sd">    (e.g. obs, obs.1, obs.2, ...). Modflow-setup writes observation input</span>
<span class="sd">    for each model layer, at each site location, with the same observation prefix (site identifier).</span>
<span class="sd">    MODFLOW-6 reports the result for each layer with duplicate column names,</span>
<span class="sd">    with layers increasing from left to right (e.g. obs, obs, obs, ...).</span>

<span class="sd">    Parse the layer number from column_name, returning zero if there is no &#39;.&#39; separator.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The approach can&#39;t be used if the model includes inactive cells (including pinched layers)</span>
<span class="sd">    at the locations of observations, because it assumes that the layer numbers are consecutive,</span>
<span class="sd">    starting at 0. For example, a pinched layer 2 in a 4 layer model would result in the observation</span>
<span class="sd">    being in layers 0, 1, 3, which would be misinterpreted as 0, 1, 2.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">column_name</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">column_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>



<div class="viewcode-block" id="get_site_no">
<a class="viewcode-back" href="../../api/mfobs.modflow.html#mfobs.modflow.get_site_no">[docs]</a>
<span class="k">def</span> <span class="nf">get_site_no</span><span class="p">(</span><span class="n">obsprefix</span><span class="p">,</span> <span class="n">obsprefix_includes_variable</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse observation site number from an observation prefix string, </span>
<span class="sd">    which may include a variable at the end, delimited by a hyphen.</span>
<span class="sd">    Also split off any part of the string after a period (&#39;.&#39;),</span>
<span class="sd">    for example index instance numbers appended by pandas.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Examples</span>
<span class="sd">    ---------</span>
<span class="sd">    &gt;&gt;&gt; get_site_no(&#39;15266500&#39;)</span>
<span class="sd">    &#39;15266500&#39;</span>
<span class="sd">    &gt;&gt;&gt; get_site_no(&#39;15266500-flow&#39;)</span>
<span class="sd">    &#39;15266500&#39;</span>
<span class="sd">    &gt;&gt;&gt; get_site_no(&#39;bc-east-fork-s12-flow&#39;)</span>
<span class="sd">    &#39;bc-east-fork-s12&#39;</span>
<span class="sd">    &gt;&gt;&gt; get_site_no(&#39;bc-east-fork-s12&#39;, obsprefix_includes_variable=False)</span>
<span class="sd">    &#39;bc-east-fork-s12&#39;</span>
<span class="sd">    &gt;&gt;&gt; get_site_no(&#39;15266500.1&#39;)</span>
<span class="sd">    &#39;15266500&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">obsprefix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">obsprefix_includes_variable</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">obsprefix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>

        
        
<div class="viewcode-block" id="get_mf6_single_variable_obs">
<a class="viewcode-back" href="../../api/mfobs.modflow.html#mfobs.modflow.get_mf6_single_variable_obs">[docs]</a>
<span class="k">def</span> <span class="nf">get_mf6_single_variable_obs</span><span class="p">(</span><span class="n">perioddata</span><span class="p">,</span>
                                <span class="n">model_output_file</span><span class="p">,</span>
                                <span class="n">gwf_obs_input_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">variable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">names_include_variable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="nb">abs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">gwf_obs_block</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read raw MODFLOW-6 observation output from csv table with</span>
<span class="sd">    times along the row axis and observations along the column axis. Reshape</span>
<span class="sd">    (stack) results to be n times x n sites rows, with a single observation value</span>
<span class="sd">    in each row. If there is more than one time in a stress period, retain only</span>
<span class="sd">    the last time (so that there is one observation per stress period for each site.</span>
<span class="sd">    If an input file to the MODFLOW-6 observation utility is included,</span>
<span class="sd">    include the observation layer number in the output.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    perioddata : str, pathlike or DataFrame</span>
<span class="sd">        Path to csv file or pandas DataFrame with start/end dates for stress periods. </span>
<span class="sd">        Must have the following columns:</span>
<span class="sd">        </span>
<span class="sd">        =================== =================================================================</span>
<span class="sd">        time                modflow simulation time, in days\ :sup:`1`</span>
<span class="sd">        start_datetime      start date for each stress period</span>
<span class="sd">        end_datetime        end date for each stress period</span>
<span class="sd">        =================== =================================================================</span>
<span class="sd">        </span>
<span class="sd">        1) Times in the `time` column must correspond to times in the </span>
<span class="sd">           `time` column of gage package output.</span>
<span class="sd">        </span>
<span class="sd">    model_output_file : str</span>
<span class="sd">        Path to MODFLOW-6 observation csv output (shape: n times rows x n obs columns).</span>
<span class="sd">    gwf_obs_input_file : str</span>
<span class="sd">        Input file to MODFLOW-6 observation utility (contains layer information).</span>
<span class="sd">    variable : str</span>
<span class="sd">        Variable name for observations. If supplied, observation prefixes will</span>
<span class="sd">        be named following the format &lt;site number&gt;-&lt;variable&gt;. </span>
<span class="sd">        If observations are already set up in MODFLOW</span>
<span class="sd">        with the format &lt;site number&gt;-&lt;variable&gt; *and* `names_include_variable=True`, </span>
<span class="sd">        then this is not needed.</span>
<span class="sd">        By default, None, in which case observation prefixes are the same </span>
<span class="sd">        as the site numbers.</span>
<span class="sd">    names_include_variable : bool</span>
<span class="sd">        Option to indicate that the names in the MODFLOW observation input</span>
<span class="sd">        have the format &lt;site number&gt;-&lt;variable&gt; (which allows for multiple</span>
<span class="sd">        observations of different variables at a site). In this case,</span>
<span class="sd">        observation prefixes will be named from the MODFLOW observation names,</span>
<span class="sd">        and any `variable` argument will be ignored.</span>
<span class="sd">        By default, False, in which case the MODFLOW observation names are assumed</span>
<span class="sd">        to be the site numbers. Observation prefixes will be formulated from the</span>
<span class="sd">        MODFLOW names and variable.</span>
<span class="sd">    abs : bool, optional</span>
<span class="sd">        Option to convert simulated values to absolute values. For example,</span>
<span class="sd">        downstream-flow observations, which by convention are reported as </span>
<span class="sd">        negative by MODFLOW 6, but will be compared to positive observed values.</span>
<span class="sd">        By default, True.</span>
<span class="sd">    gwf_obs_block : None or int</span>
<span class="sd">        Argument to read a specific observation block or all blocks from GWF </span>
<span class="sd">        observation utility file. Value of None returns observations from all </span>
<span class="sd">        blocks. Integer value returns obs from a specifc block, in (zero-based)</span>
<span class="sd">        order, from top to bottom. For example, a value of 0 would return the </span>
<span class="sd">        first obs block, value of 1 would return the second obs block, and so </span>
<span class="sd">        on. Modflow-setup writes all of the observation input to a single block, </span>
<span class="sd">        but observation input can be broken out into multiple blocks (one per </span>
<span class="sd">        file). By default, None (All blocks)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    results : DataFrame</span>
<span class="sd">        DataFrame with one head observation per row, with the following columns:</span>

<span class="sd">        =================== =============================================================</span>
<span class="sd">        datetime            pandas datetimes, based on stress period start date</span>
<span class="sd">        site_no             unique identifier for each site</span>
<span class="sd">        variable            MODFLOW variable name for observed value</span>
<span class="sd">        obsprefix           prefix of observation name (site identifier)</span>
<span class="sd">        sim_obsval          simulated values</span>
<span class="sd">        time                modflow simulation time, in days</span>
<span class="sd">        per                 modflow stress period\ :sup:`1`</span>
<span class="sd">        =================== =============================================================</span>
<span class="sd">        </span>
<span class="sd">        1) Stress period information is needed to differentiate between </span>
<span class="sd">           steady-state and transient observations that may have the same timestamp.</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># read in/set up the perioddata table</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">perioddata</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">perioddata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">perioddata</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">perioddata</span> <span class="o">=</span> <span class="n">perioddata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>        
    <span class="n">set_period_start_end_dates</span><span class="p">(</span><span class="n">perioddata</span><span class="p">)</span>
    <span class="n">perioddata</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">perioddata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
        
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reading model output from </span><span class="si">{}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_output_file</span><span class="p">))</span>
    <span class="n">model_output</span> <span class="o">=</span> <span class="n">read_csv</span><span class="p">(</span><span class="n">model_output_file</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

    <span class="c1"># convert all observation names to lower case</span>
    <span class="n">model_output</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">model_output</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># add stress period information to model output</span>
    <span class="c1"># by having pandas match time floats in indices</span>
    <span class="c1"># the last time in each stress period is retained</span>
    <span class="c1"># (corresponding to the model end time listed in perioddata)</span>
    <span class="n">model_output</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">model_output</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
    <span class="n">perioddata</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">perioddata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
    <span class="n">model_output</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">perioddata</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">]</span>
    <span class="n">model_output</span><span class="p">[</span><span class="s1">&#39;perioddata_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">perioddata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
    <span class="c1"># TODO: backfill head so that all times have SP and time info</span>
    <span class="c1"># add timestep info as well</span>
    <span class="n">model_output</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">model_output</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_output</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">model_output</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">model_output</span><span class="o">.</span><span class="n">perioddata_time</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="c1">#model_output.index = model_output[&#39;per&#39;]</span>

    <span class="c1"># reshape the model output from (nper rows, nsites columns) to nper x nsites rows</span>
    <span class="n">periods</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">perioddata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">perioddata</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">]))</span>
    <span class="n">stacked</span> <span class="o">=</span> <span class="n">model_output</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;perioddata_time&#39;</span><span class="p">,</span> <span class="s1">&#39;per&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">simval_col</span> <span class="o">=</span> <span class="s1">&#39;sim_obsval&#39;</span>
    <span class="n">stacked</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;obsprefix&#39;</span><span class="p">,</span> <span class="n">simval_col</span><span class="p">]</span>
    
    <span class="n">stacked</span><span class="p">[</span><span class="s1">&#39;site_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_site_no</span><span class="p">(</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">obsprefix_includes_variable</span><span class="o">=</span><span class="n">names_include_variable</span><span class="p">)</span> 
                          <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stacked</span><span class="o">.</span><span class="n">obsprefix</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">names_include_variable</span><span class="p">:</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stacked</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;names_include_variable=True, &#39;</span>
                                 <span class="sa">f</span><span class="s1">&#39;but observation prefix: </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1"> only has one component.&#39;</span>
                                 <span class="s1">&#39;When names_include_variable=True, observation prefixes &#39;</span>
                                 <span class="s1">&#39;are expected to be in the format &lt;site number&gt;-&lt;variable&gt;.&#39;</span><span class="p">)</span>
            <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">stacked</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variables</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stacked</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">variable</span>
    <span class="n">stacked</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">periods</span><span class="p">[</span><span class="n">time</span><span class="p">]</span> <span class="k">for</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">stacked</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]]</span>
    <span class="n">stacked</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">stacked</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>

    <span class="c1"># optionally convert simulated values to absolute values</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">:</span>
        <span class="n">stacked</span><span class="p">[</span><span class="n">simval_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">stacked</span><span class="p">[</span><span class="n">simval_col</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
    
    <span class="c1"># add dates</span>
    <span class="n">stacked</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">perioddata</span><span class="p">[</span><span class="s1">&#39;end_datetime&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">stacked</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
    
    <span class="c1"># add dates</span>
    <span class="c1">#perlen = dict(zip(perioddata.per, perioddata.perlen))</span>
    <span class="c1">#period_start_dates = dict(zip(perioddata.per, perioddata.start_datetime))</span>
    <span class="c1">#period_end_dates = dict(zip(perioddata.per, perioddata.end_datetime))</span>
    <span class="c1">#stacked[&#39;datetime&#39;] = pd.to_datetime([period_end_dates.get(per) for per in stacked.per])</span>
    <span class="c1"># get the start date of the next period</span>
    <span class="c1"># so that suffix for an observation would be consistent with the start date of the next obs</span>
    <span class="c1">#next_period_start = [period_start_dates.get(per) for per in stacked.per][1:]</span>
    <span class="c1">#last_per = perioddata.per.max()</span>
    <span class="c1">#last_end_date = pd.Timestamp(period_start_dates[last_per]) + \</span>
    <span class="c1">#    pd.Timedelta(perlen[last_per], unit=&#39;d&#39;)</span>
    <span class="c1">#next_period_start.append(last_end_date)</span>

    <span class="c1"># parse the layers from the column positions (prior to stacking)</span>
    <span class="k">if</span> <span class="n">gwf_obs_input_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">gwf_obs_input</span> <span class="o">=</span> <span class="n">get_gwf_obs_input</span><span class="p">(</span><span class="n">gwf_obs_input_file</span><span class="p">,</span> 
                                          <span class="n">gwf_obs_block</span><span class="o">=</span><span class="n">gwf_obs_block</span><span class="p">)</span>
        <span class="c1"># Assign layer to each observation,</span>
        <span class="c1"># assuming that numbering in gwf_obs_input is repeated nper times</span>
        <span class="n">ntimes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stacked</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">stacked</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gwf_obs_input</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">*</span> <span class="n">ntimes</span>

    <span class="c1"># reset the obsprefixes to be the same for different layers at a location</span>
    <span class="n">stacked</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">prefix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">stacked</span><span class="o">.</span><span class="n">obsprefix</span><span class="p">]</span>

    <span class="c1"># assign obsnames using the prefixes (location identifiers) and month</span>
    <span class="c1">#obsnames = []</span>
    <span class="c1">#for prefix, per, dt in zip(stacked.obsprefix, stacked.per, stacked.datetime):</span>
    <span class="c1">#    if per == label_period_as_steady_state:</span>
    <span class="c1">#        name = f&quot;{prefix}_ss&quot;</span>
    <span class="c1">#    elif obsnme_date_suffix and not pd.isnull(dt):</span>
    <span class="c1">#        name = f&quot;{prefix}_{dt.strftime(obsnme_suffix_format)}&quot;</span>
    <span class="c1">#    elif not obsnme_date_suffix:</span>
    <span class="c1">#        suffix = f&quot;{per:{obsnme_suffix_format.strip(&#39;{:}&#39;)}}&quot;</span>
    <span class="c1">#        name = f&quot;{prefix}_{suffix}&quot;</span>
    <span class="c1">#    else:</span>
    <span class="c1">#        name = prefix</span>
    <span class="c1">#    obsnames.append(name)</span>
    <span class="c1">#stacked[&#39;obsnme&#39;] = obsnames</span>

    <span class="c1"># drop any duplicate observations, keeping those from transient periods</span>
    <span class="c1"># (for example, an initial steady-state period that isn&#39;t being used for observations</span>
    <span class="c1"># and a subsequent transient period with the same start date)</span>
    <span class="c1"># first make temp obsnames that include layer</span>
    <span class="c1"># steady state periods that are being used for observations (label_period_as_steady_state=True)</span>
    <span class="c1"># won&#39;t be dropped because their obs will have an &quot;ss&quot; suffix instead of a date suffix</span>
    <span class="c1">#if gwf_obs_input_file is not None:</span>
    <span class="c1">#    unique_obsnames = [&#39;{}_{}&#39;.format(name, layer)</span>
    <span class="c1">#                       for name, layer in zip(stacked.obsnme, stacked.layer)]</span>
    <span class="c1">#else:</span>
    <span class="c1">#    unique_obsnames = stacked.obsnme.to_list()</span>
    <span class="c1">#stacked[&#39;unique_obsnames&#39;] = unique_obsnames</span>
    <span class="c1">#are_duplicates = stacked[&#39;unique_obsnames&#39;].duplicated(keep=False)</span>
    <span class="c1">##are_duplicates = pd.Series(unique_obsnames).duplicated(keep=False).values</span>
    <span class="c1">#if any(are_duplicates):</span>
    <span class="c1">#    #duplicated_obsnames = set(stacked.loc[are_duplicates.values, &#39;obsnme&#39;])</span>
    <span class="c1">#    steady_obs = stacked.per.isin(perioddata.loc[perioddata.steady, &#39;per&#39;].values)</span>
    <span class="c1">#    drop = are_duplicates &amp; steady_obs</span>
    <span class="c1">#    stacked = stacked.loc[~drop]</span>
    <span class="c1">#    #unique_obsnames = np.array(unique_obsnames)[~drop]</span>
    <span class="c1">#    #assert not any(pd.Series(unique_obsnames).duplicated())</span>
    <span class="c1">#if stacked[&#39;unique_obsnames&#39;].duplicated().any():</span>
    <span class="c1">#    duplicates = stacked.loc[stacked[&#39;unique_obsnames&#39;]. \</span>
    <span class="c1">#        duplicated(keep=False)].sort_values(by=&#39;unique_obsnames&#39;)</span>
    <span class="c1">#    msg = (&quot;mfobs.modflow.get_mf6_single_variable_obs:&quot;</span>
    <span class="c1">#           &quot;Duplicate observation names.\n\nIf obsnme_date_suffix=True, &quot;</span>
    <span class="c1">#           &quot;you may need a more specific obsnme_suffix_format, e.g. &#39;%Y%m%d\n\n&quot;</span>
    <span class="c1">#           &quot;Or, if the head observation input to MODFLOW is set up with an observation in each layer,\n&quot;</span>
    <span class="c1">#           &quot;supply a gwf_obs_input_file so that unique observations can identified in each layer.\n\n&quot;</span>
    <span class="c1">#           &quot;There could also be a mismatch between the time discretization of the model results (e.g. perlen)\n&quot;</span>
    <span class="c1">#           &quot;and the start and end dates in the stress period data table (perioddata).\n&quot;</span>
    <span class="c1">#           &quot;In the latter case, you may need to re-run the model &quot;</span>
    <span class="c1">#           f&quot;and possibly the model setup.\n\nDuplicated obs:{duplicates}&quot;</span>
    <span class="c1">#           &quot;&quot;</span>
    <span class="c1">#           )</span>
    <span class="c1">#    raise ValueError(msg)</span>
<span class="c1">#</span>
    <span class="c1">#stacked.index = stacked[&#39;obsnme&#39;]</span>
    <span class="n">stacked</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sort_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">stacked</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">stacked</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">sort_cols</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">stacked</span><span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">sn</span><span class="p">)</span> 
                            <span class="k">for</span> <span class="n">sn</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">stacked</span><span class="p">[</span><span class="s1">&#39;site_no&#39;</span><span class="p">],</span> <span class="n">stacked</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">])]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;site_no&#39;</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="s1">&#39;obsprefix&#39;</span><span class="p">,</span>
            <span class="n">simval_col</span><span class="p">,</span> <span class="s1">&#39;layer&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;per&#39;</span><span class="p">]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">stacked</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">stacked</span><span class="o">.</span><span class="n">columns</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">results</span></div>



<div class="viewcode-block" id="read_mf_gage_package_output_files">
<a class="viewcode-back" href="../../api/mfobs.modflow.html#mfobs.modflow.read_mf_gage_package_output_files">[docs]</a>
<span class="k">def</span> <span class="nf">read_mf_gage_package_output_files</span><span class="p">(</span><span class="n">gage_package_output_files</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read one of more gage package output files into a single table. If multiple</span>
<span class="sd">    files are specified, a single variable to return must be specified.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gage_package_output_files : str/pathlike, or list of pathlikes</span>
<span class="sd">        Path to gage package output file(s). </span>
<span class="sd">        Multiple files will be concatenated into one output table.</span>
<span class="sd">    variable : str</span>
<span class="sd">        Variable to return. Only required if multiple files are </span>
<span class="sd">        specified to gage_package_output_files.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : DataFrame</span>
<span class="sd">        Gage package output, with times along the row axis, </span>
<span class="sd">        and variables or sites along the column axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gage_package_output_files</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gage_package_output_files</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">gage_package_output_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">gage_package_output_files</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">variable</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mfobs.modflow.read_mf_gage_package_output_files: &quot;</span>
                             <span class="s2">&quot;variable must be specified when reading multiple files.&quot;</span><span class="p">)</span>

    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">gage_package_output_files</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;reading model output from </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
        <span class="c1"># set the observation prefix (site name) from file name</span>
        <span class="n">obsprefix</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">src</span><span class="p">))</span>
            <span class="n">names</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">src</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;DATA:&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">s+&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">variable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">variable</span> <span class="o">=</span> <span class="n">variable</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">variable</span><span class="p">]]</span>  <span class="c1"># keep as DataFrame</span>
                <span class="n">col_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">obsprefix</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">variable</span><span class="p">:</span> <span class="n">col_name</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


        
<div class="viewcode-block" id="get_mf_gage_package_obs">
<a class="viewcode-back" href="../../api/mfobs.modflow.html#mfobs.modflow.get_mf_gage_package_obs">[docs]</a>
<span class="k">def</span> <span class="nf">get_mf_gage_package_obs</span><span class="p">(</span><span class="n">perioddata</span><span class="p">,</span>
                            <span class="n">gage_package_output_files</span><span class="p">,</span>
                            <span class="n">gwf_obs_input_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">variable</span><span class="o">=</span><span class="s1">&#39;flow&#39;</span><span class="p">,</span>
                            <span class="nb">abs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read raw MODFLOW gage package text file output with</span>
<span class="sd">    times along the row axis and observations along the column axis. Reshape</span>
<span class="sd">    (stack) results to be n times x n sites rows, with a single observation value</span>
<span class="sd">    in each row. </span>
<span class="sd">    </span>
<span class="sd">    Observations can be aggregated from the raw model output to</span>
<span class="sd">    the stress period level (aggregate_obs_to_stress_periods=True), which is often desired</span>
<span class="sd">    for models with monthly stress periods. If there is more than one time in a stress period, </span>
<span class="sd">    only the last timestep is retained (so that there is one observation per stress period for each site).</span>
<span class="sd">    </span>
<span class="sd">    Alternatively, for models with daily stresses on daily timesteps (for example, GSFLOW), observations </span>
<span class="sd">    can be created for each timestep.</span>
<span class="sd">    </span>
<span class="sd">    If an input file to the MODFLOW observation package is specified,</span>
<span class="sd">    include the observation layer number in the output.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    perioddata : str, pathlike or DataFrame</span>
<span class="sd">        Path to csv file or pandas DataFrame with start/end dates for stress periods. </span>
<span class="sd">        Must have the following columns:</span>
<span class="sd">        </span>
<span class="sd">        =================== =================================================================</span>
<span class="sd">        time                modflow simulation time, in days\ :sup:`1`</span>
<span class="sd">        start_datetime      start date for each stress period</span>
<span class="sd">        end_datetime        end date for each stress period</span>
<span class="sd">        =================== =================================================================</span>
<span class="sd">        </span>
<span class="sd">        1) Times in the `time` column must correspond to times in the </span>
<span class="sd">           `time` column of gage package output.</span>
<span class="sd">        </span>
<span class="sd">    gage_package_output_files : str/pathlike, or list of pathlikes</span>
<span class="sd">        Path to gage package output file(s). </span>
<span class="sd">        Multiple files will be concatenated into one output table.</span>
<span class="sd">    model_obs_input_file : str</span>
<span class="sd">        Input file to MODFLOW (hydmod or gage??) for observations.</span>
<span class="sd">    variable : str or sequence</span>
<span class="sd">        Variable(s) to read from gage package output.</span>
<span class="sd">    abs : bool, optional</span>
<span class="sd">        Option to convert simulated values to absolute values</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    results : DataFrame</span>
<span class="sd">        DataFrame with one head observation per row, with the following columns:</span>

<span class="sd">        =================== =============================================================</span>
<span class="sd">        datetime            pandas datetimes, based on stress period start date</span>
<span class="sd">        site_no             unique identifier for each site</span>
<span class="sd">        variable            PRMS variable name</span>
<span class="sd">        obsprefix           prefix of observation name (site identifier)</span>
<span class="sd">        sim_obsval          simulated values</span>
<span class="sd">        time                modflow simulation time, in days</span>
<span class="sd">        per                 modflow stress period\ :sup:`1`</span>
<span class="sd">        =================== =============================================================</span>
<span class="sd">        </span>
<span class="sd">        1) Stress period information is needed to differentiate between </span>
<span class="sd">           steady-state and transient observations that may have the same timestamp.</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># read in/set up the perioddata table</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">perioddata</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">perioddata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">perioddata</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">perioddata</span> <span class="o">=</span> <span class="n">perioddata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>        
    <span class="n">set_period_start_end_dates</span><span class="p">(</span><span class="n">perioddata</span><span class="p">)</span>
    <span class="n">perioddata</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">perioddata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gage_package_output_files</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gage_package_output_files</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">gage_package_output_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">gage_package_output_files</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">variable</span> <span class="o">=</span> <span class="p">[</span><span class="n">variable</span><span class="p">]</span>
        
    <span class="n">simval_col</span> <span class="o">=</span> <span class="s1">&#39;sim_obsval&#39;</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">variable</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">read_mf_gage_package_output_files</span><span class="p">(</span><span class="n">gage_package_output_files</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">output</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;obsprefix&#39;</span><span class="p">,</span> <span class="n">simval_col</span><span class="p">]</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="n">model_output</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>

    <span class="c1"># (columns from read_mf_gage_package_output_files should all be lower case)</span>

    <span class="c1"># add stress period information to model output</span>
    <span class="c1"># by having pandas match time floats in indices</span>
    <span class="c1"># the last time in each stress period is retained</span>
    <span class="c1"># (corresponding to the model end time listed in perioddata)</span>
    <span class="n">model_output</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">model_output</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
    <span class="n">perioddata</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">perioddata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
    <span class="n">model_output</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">perioddata</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">]</span>
    <span class="n">model_output</span><span class="p">[</span><span class="s1">&#39;perioddata_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">perioddata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
    <span class="n">model_output</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">model_output</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_output</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">model_output</span><span class="p">[</span><span class="s1">&#39;site_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model_output</span><span class="o">.</span><span class="n">obsprefix</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
    <span class="n">model_output</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model_output</span><span class="o">.</span><span class="n">obsprefix</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)]</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">model_output</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">model_output</span><span class="o">.</span><span class="n">perioddata_time</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="c1">#model_output.index = model_output[&#39;time&#39;]</span>

    <span class="c1"># reshape the model output from (nper rows, nsites columns) to nper x nsites rows</span>
    <span class="c1">#stacked = model_output.drop([&#39;time&#39;, &#39;perioddata_time&#39;, &#39;per&#39;], axis=1).stack(level=0).reset_index()</span>
    <span class="c1">#simval_col = &#39;sim_{}&#39;.format(variable_name)</span>
    <span class="c1">#stacked.columns = [&#39;per&#39;, &#39;obsprefix&#39;, simval_col]</span>
    <span class="n">stacked</span> <span class="o">=</span> <span class="n">model_output</span>

    <span class="c1"># optionally convert simulated values to absolute values</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">:</span>
        <span class="n">stacked</span><span class="p">[</span><span class="n">simval_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">stacked</span><span class="p">[</span><span class="n">simval_col</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>

    <span class="c1"># add dates</span>
    <span class="n">stacked</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">perioddata</span><span class="p">[</span><span class="s1">&#39;end_datetime&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">stacked</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
    
    <span class="c1">#period_end_dates = dict(zip(perioddata.per, perioddata.end_datetime))</span>
    <span class="c1">#stacked[&#39;datetime&#39;] = pd.to_datetime([period_end_dates.get(per) for per in stacked.per])</span>
    <span class="c1"># get the start date of the next period</span>
    <span class="c1"># so that suffix for an observation would be consistent with the start date of the next obs</span>
    <span class="c1">#next_period_start = [period_start_dates.get(per) for per in stacked.per][1:]</span>
    <span class="c1">#last_per = perioddata.per.max()</span>
    <span class="c1">#last_end_date = pd.Timestamp(period_start_dates[last_per]) + \</span>
    <span class="c1">#    pd.Timedelta(perlen[last_per], unit=&#39;d&#39;)</span>
    <span class="c1">#next_period_start.append(last_end_date)</span>

    <span class="c1"># parse the layers from the column positions (prior to stacking)</span>
    <span class="c1">#if gwf_obs_input_file is not None:</span>
    <span class="c1">#    gwf_obs_input = get_gwf_obs_input(gwf_obs_input_file)</span>
    <span class="c1">#    # Assign layer to each observation,</span>
    <span class="c1">#    # assuming that numbering in gwf_obs_input is repeated nper times</span>
    <span class="c1">#    nper = len(stacked.per.unique())</span>
    <span class="c1">#    stacked[&#39;layer&#39;] = gwf_obs_input[&#39;k&#39;].tolist() * nper</span>

    <span class="c1"># reset the obsprefixes to be the same for different layers at a location</span>
    <span class="c1">#stacked[&#39;obsprefix&#39;] = [prefix.split(&#39;.&#39;)[0] for prefix in stacked.obsprefix]</span>

    <span class="c1"># assign obsnames using the prefixes (location identifiers) and month</span>
    <span class="c1">#obsnames = []</span>
    <span class="c1">#for prefix, per, dt in zip(stacked.obsprefix, stacked.per, stacked.datetime):</span>
    <span class="c1">#    if per == label_period_as_steady_state:</span>
    <span class="c1">#        name = f&quot;{prefix}_ss&quot;</span>
    <span class="c1">#    elif obsnme_date_suffix and not pd.isnull(dt):</span>
    <span class="c1">#        name = f&quot;{prefix}_{dt.strftime(obsnme_suffix_format)}&quot;</span>
    <span class="c1">#    elif not obsnme_date_suffix:</span>
    <span class="c1">#        suffix = f&quot;{per:{obsnme_suffix_format.strip(&#39;{:}&#39;)}}&quot;</span>
    <span class="c1">#        name = f&quot;{prefix}_{suffix}&quot;</span>
    <span class="c1">#    else:</span>
     <span class="c1">#       name = prefix</span>
    <span class="c1">#    obsnames.append(name)</span>
    <span class="c1">#stacked[&#39;obsnme&#39;] = obsnames</span>

    <span class="c1"># drop any duplicate observations, keeping those from transient periods</span>
    <span class="c1"># (for example, an initial steady-state period that isn&#39;t being used for observations</span>
    <span class="c1"># and a subsequent transient period with the same start date)</span>
    <span class="c1"># first make temp obsnames that include layer</span>
    <span class="c1"># steady state periods that are being used for observations (label_period_as_steady_state=True)</span>
    <span class="c1"># won&#39;t be dropped because their obs will have an &quot;ss&quot; suffix instead of a date suffix</span>
    <span class="c1">#if gwf_obs_input_file is not None:</span>
    <span class="c1">#    unique_obsnames = [&#39;{}_{}&#39;.format(name, layer)</span>
    <span class="c1">#                       for name, layer in zip(stacked.obsnme, stacked.layer)]</span>
    <span class="c1">#else:</span>
    <span class="c1">#    unique_obsnames = stacked.obsnme.to_list()</span>
    <span class="c1">#stacked[&#39;unique_obsnames&#39;] = unique_obsnames</span>
    <span class="c1">#are_duplicates = stacked[&#39;unique_obsnames&#39;].duplicated(keep=False)</span>
    <span class="c1">#are_duplicates = pd.Series(unique_obsnames).duplicated(keep=False).values</span>
    <span class="c1">#if any(are_duplicates):</span>
    <span class="c1">#    #duplicated_obsnames = set(stacked.loc[are_duplicates.values, &#39;obsnme&#39;])</span>
    <span class="c1">#    steady_obs = stacked.per.isin(perioddata.loc[perioddata.steady, &#39;per&#39;].values)</span>
    <span class="c1">#    drop = are_duplicates &amp; steady_obs</span>
    <span class="c1">#    stacked = stacked.loc[~drop]</span>
    <span class="c1">#    #unique_obsnames = np.array(unique_obsnames)[~drop]</span>
    <span class="c1">#    #assert not any(pd.Series(unique_obsnames).duplicated())</span>
    <span class="c1">#if stacked[&#39;unique_obsnames&#39;].duplicated().any():</span>
    <span class="c1">#    duplicates = stacked.loc[stacked[&#39;unique_obsnames&#39;]. \</span>
    <span class="c1">#        duplicated(keep=False)].sort_values(by=&#39;unique_obsnames&#39;)</span>
    <span class="c1">#    msg = (&quot;mfobs.modflow.get_mf6_single_variable_obs:&quot;</span>
    <span class="c1">#           &quot;Duplicate observation names. If obsnme_date_suffix=True, &quot;</span>
    <span class="c1">#           &quot;you may need a more specific obsnme_suffix_format, e.g. &#39;%Y%m%d\n&quot;</span>
    <span class="c1">#           &quot;Or there may be a mismatch between the model results (e.g. perlen) &quot;</span>
    <span class="c1">#           &quot;and start and end dates in the stress period data table (perioddata).\n&quot;</span>
    <span class="c1">#           &quot;In the latter case, you may need to re-run the model &quot;</span>
    <span class="c1">#           f&quot;and possibly the model setup.\nDuplicated obs:{duplicates}&quot;</span>
    <span class="c1">#           &quot;&quot;</span>
    <span class="c1">#           )</span>
    <span class="c1">#    raise ValueError(msg)</span>
<span class="c1">#</span>
    <span class="c1">#stacked.index = stacked[&#39;obsnme&#39;]</span>
    <span class="n">stacked</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sort_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;obsprefix&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">stacked</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">stacked</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">sort_cols</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">stacked</span><span class="p">[[</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="s1">&#39;site_no&#39;</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="s1">&#39;obsprefix&#39;</span><span class="p">,</span>
                       <span class="n">simval_col</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;per&#39;</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">results</span></div>



<div class="viewcode-block" id="get_modflow_mass_balance">
<a class="viewcode-back" href="../../api/mfobs.modflow.html#mfobs.modflow.get_modflow_mass_balance">[docs]</a>
<span class="k">def</span> <span class="nf">get_modflow_mass_balance</span><span class="p">(</span><span class="n">modroot</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">write_ins</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    read in the percent discrepancy for inset and parent models</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    modroot: root name of the model scenario</span>
<span class="sd">    outfile: filepath for output</span>
<span class="sd">    write_ins: bool. whether or not to write instruction file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reading in the mass balance files&#39;</span><span class="p">)</span>
    <span class="c1"># make a list with which to concatenate results</span>
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># read in both inset and parent list files</span>
    <span class="k">for</span> <span class="n">cmod</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;inset&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">]:</span>
        <span class="c1"># read in the list files</span>
        <span class="n">mfl6</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Mf6ListBudget</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">.list&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">modroot</span><span class="p">,</span> <span class="n">cmod</span><span class="p">))</span>
        <span class="c1"># get all the budget information</span>
        <span class="n">df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mfl6</span><span class="o">.</span><span class="n">get_dataframes</span><span class="p">(</span><span class="n">start_datetime</span><span class="o">=</span><span class="s2">&quot;1-1-2012&quot;</span><span class="p">)</span>
        <span class="c1"># construct the obsname with the date etc.</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_discrep_</span><span class="si">{1:d}{2:02d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmod</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">month</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="c1"># append on the max absolute percent discrepancy</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;obsnme&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_discrep_max&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmod</span><span class="p">),</span>
                        <span class="s1">&#39;PERCENT_DISCREPANCY&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">PERCENT_DISCREPANCY</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()},</span>
                       <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;obsnme&#39;</span><span class="p">,</span> <span class="s1">&#39;PERCENT_DISCREPANCY&#39;</span><span class="p">]])</span>
    <span class="n">outdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
    <span class="n">outdf</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;percent_discrep&#39;</span>
    <span class="n">outdf</span><span class="p">[</span><span class="s1">&#39;obsval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">outdf</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;wrote </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">outdf</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1"> observations to </span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">write_ins</span><span class="p">:</span>
        <span class="n">write_insfile</span><span class="p">(</span><span class="n">outdf</span><span class="p">,</span> <span class="n">outfile</span> <span class="o">+</span> <span class="s1">&#39;.ins&#39;</span><span class="p">,</span> <span class="n">obsnme_column</span><span class="o">=</span><span class="s1">&#39;obsnme&#39;</span><span class="p">,</span>
                      <span class="n">simulated_obsval_column</span><span class="o">=</span><span class="s1">&#39;PERCENT_DISCREPANCY&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_modelgrid_transform">
<a class="viewcode-back" href="../../api/mfobs.modflow.html#mfobs.modflow.get_modelgrid_transform">[docs]</a>
<span class="k">def</span> <span class="nf">get_modelgrid_transform</span><span class="p">(</span><span class="n">grid_json_file</span><span class="p">,</span> <span class="n">shift_to_cell_centers</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create an affine.Affine that describes the model grid</span>
<span class="sd">    from a json file. The affine package comes with rasterio</span>
<span class="sd">    as a dependency or can be installed separately.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    grid_json_file : str</span>
<span class="sd">        Model grid json file produced by modflow-setup</span>
<span class="sd">    shift_to_cell_centers : bool</span>
<span class="sd">        By default, transform reflects the upper left corner of</span>
<span class="sd">        the first cell in the model, and any conversions of x, y</span>
<span class="sd">        coordinates to pixels will be relative to upper left corners.</span>
<span class="sd">        If shift_to_cell_centers=True, x,y points will be referenced</span>
<span class="sd">        to the nearest cell centers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">grid_json_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="s1">&#39;delr&#39;</span><span class="p">,</span> <span class="s1">&#39;delc&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="n">dx</span><span class="p">]):</span>
            <span class="n">cfg</span><span class="p">[</span><span class="n">dx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="n">dx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">xul</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;xul&#39;</span><span class="p">]</span>
    <span class="n">yul</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;yul&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">shift_to_cell_centers</span><span class="p">:</span>
        <span class="n">xul</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;delr&#39;</span><span class="p">]</span>
        <span class="n">yul</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;delc&#39;</span><span class="p">]</span>

    <span class="n">transform</span> <span class="o">=</span> <span class="n">Affine</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;delr&#39;</span><span class="p">],</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">xul</span><span class="p">,</span>
                       <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;delc&#39;</span><span class="p">],</span> <span class="n">yul</span><span class="p">)</span> <span class="o">*</span> \
                <span class="n">Affine</span><span class="o">.</span><span class="n">rotation</span><span class="p">(</span><span class="o">-</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;angrot&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">transform</span></div>



<div class="viewcode-block" id="read_mf6_lake_obs">
<a class="viewcode-back" href="../../api/mfobs.modflow.html#mfobs.modflow.read_mf6_lake_obs">[docs]</a>
<span class="k">def</span> <span class="nf">read_mf6_lake_obs</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">perioddata</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="s1">&#39;2012-01-01&#39;</span><span class="p">,</span>
                      <span class="n">keep_only_last_timestep</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># convert modflow time to actual elapsed time</span>
    <span class="c1"># (by subtracting off the day for the initial steady-state period)</span>
    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="c1"># get stress period information for each timestep recorded</span>
    <span class="n">kstp</span><span class="p">,</span> <span class="n">kper</span> <span class="o">=</span> <span class="n">get_kstp_kper</span><span class="p">(</span><span class="n">perioddata</span><span class="o">.</span><span class="n">nstp</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;kstp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kstp</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;kper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kper</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">kstp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">keep_only_last_timestep</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;kper&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">start_ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">start_date</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">start_ts</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">datetime</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;datetime&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_transmissivities">
<a class="viewcode-back" href="../../api/mfobs.modflow.html#mfobs.modflow.get_transmissivities">[docs]</a>
<span class="k">def</span> <span class="nf">get_transmissivities</span><span class="p">(</span><span class="n">heads</span><span class="p">,</span> <span class="n">hk</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">botm</span><span class="p">,</span>
                         <span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">j</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">modelgrid_transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">screen_top</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">screen_botm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                         <span class="n">include_zero_open_intervals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">nodata</span><span class="o">=-</span><span class="mi">999</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes transmissivity in each model layer at specified locations and</span>
<span class="sd">    open intervals. A saturated thickness is determined for each row, column</span>
<span class="sd">    or x, y location supplied, based on the open interval (sctop, screen_botm),</span>
<span class="sd">    if supplied, otherwise the layer tops and bottoms and the water table</span>
<span class="sd">    are used.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    heads : 2D array OR 3D array</span>
<span class="sd">        numpy array of shape nlay by n locations (2D) OR complete heads array</span>
<span class="sd">        of the model for one time (3D)</span>
<span class="sd">    hk : 3D numpy array</span>
<span class="sd">        horizontal hydraulic conductivity values.</span>
<span class="sd">    top : 2D numpy array</span>
<span class="sd">        model top elevations.</span>
<span class="sd">    botm : 3D numpy array</span>
<span class="sd">        layer botm elevations.</span>
<span class="sd">    i : 1D array-like of ints, of length n locations</span>
<span class="sd">        zero-based row indices (optional; alternately specify x, y)</span>
<span class="sd">    j : 1D array-like of ints, of length n locations</span>
<span class="sd">        zero-based column indices (optional; alternately specify x, y)</span>
<span class="sd">    x : 1D array-like of floats, of length n locations</span>
<span class="sd">        x locations in real world coordinates (optional).</span>
<span class="sd">        If x and y are specified, a modelgrid_transform must also be provided.</span>
<span class="sd">    y : 1D array-like of floats, of length n locations</span>
<span class="sd">        y locations in real world coordinates (optional)</span>
<span class="sd">        If x and y are specified, a modelgrid_transform must also be provided.</span>
<span class="sd">    modelgrid_transform : affine.Affine instance, optional</span>
<span class="sd">        An `affine.Affine &lt;https://github.com/sgillies/affine&gt;`_ object describing the orientation</span>
<span class="sd">        of the model grid. Only required for getting i, j if x and y are specified.</span>
<span class="sd">        Modflow-setup :class:`~mfsetup.grid.MFsetupGrid` have this attached</span>
<span class="sd">        via the :meth:`~mfsetup.grid.MFsetupGrid.transform` property. Example::</span>

<span class="sd">            modelgrid_transform=affine.Affine(1000.0, 0.0, 500955,</span>
<span class="sd">                                              0.0, -1000.0, 1205285)</span>

<span class="sd">        for a uniform spacing of 1000 and upper left corner of 500955, 1205285</span>
<span class="sd">        with a rotation of 45 degrees, counter-clockwise about the upper left corner::</span>

<span class="sd">            modelgrid_transform=affine.Affine(1000.0, 0.0, 500955,</span>
<span class="sd">                                              0.0, -1000.0, 1205285).rotation(45.)</span>

<span class="sd">        An ``affine.Affine`` instance can also be created from a</span>
<span class="sd">        `Modflow-setup &lt;https://github.com/aleaf/modflow-setup&gt;`_</span>
<span class="sd">        grid JSON file via the :func:`~mfobs.modflow.get_modelgrid_transform` function.</span>

<span class="sd">    screen_top : 1D array-like of floats, of length n locations</span>
<span class="sd">        open interval tops (optional; default is model top)</span>
<span class="sd">    screen_botm : 1D array-like of floats, of length n locations</span>
<span class="sd">        open interval bottoms (optional; default is model bottom)</span>
<span class="sd">    include_zero_open_intervals : bool</span>
<span class="sd">        In cases where the screen top and screen bottom elevations are equal,</span>
<span class="sd">        assign the model layer transmissivity for the cell containing</span>
<span class="sd">        the screen top/bottom.</span>
<span class="sd">    nodata : numeric</span>
<span class="sd">        optional; locations where heads=nodata will be assigned T=0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    T : 2D array of same shape as heads (nlay x n locations)</span>
<span class="sd">        Transmissivities in each layer at each location</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">j</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># get row, col for observation locations</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">get_ij</span><span class="p">(</span><span class="n">modelgrid_transform</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must specify row, column or x, y locations.&#39;</span><span class="p">)</span>

    <span class="c1"># get k-values and botms at those locations</span>
    <span class="c1"># (make nlayer x n sites arrays)</span>
    <span class="n">hk2d</span> <span class="o">=</span> <span class="n">hk</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
    <span class="n">botm2d</span> <span class="o">=</span> <span class="n">botm</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">hk2d</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">botm2d</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;hk and bottom arrays must have consistent dimensions&#39;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">heads</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">heads</span> <span class="o">=</span> <span class="n">heads</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Shape of heads array must be nlay x nhyd&#39;</span>
    <span class="k">assert</span> <span class="n">heads</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">botm2d</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">msg</span>

    <span class="c1"># set open interval tops/bottoms to model top/bottom if None</span>
    <span class="k">if</span> <span class="n">screen_top</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">screen_top</span> <span class="o">=</span> <span class="n">top</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">screen_botm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">screen_botm</span> <span class="o">=</span> <span class="n">botm</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>

    <span class="c1"># make an nlayers x n sites array of layer tops</span>
    <span class="n">tops</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">botm2d</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">tops</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">top</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
    <span class="n">tops</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">botm2d</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># expand top and bottom arrays to be same shape as botm, thickness, etc.</span>
    <span class="c1"># (so we have an open interval value for each layer)</span>
    <span class="n">sctoparr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">botm2d</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">sctoparr</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">screen_top</span>
    <span class="n">scbotarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">botm2d</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">scbotarr</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">screen_botm</span>

    <span class="c1"># start with layer tops</span>
    <span class="c1"># set tops above heads to heads</span>
    <span class="c1"># set tops above screen top to screen top</span>
    <span class="c1"># (we only care about the saturated open interval)</span>
    <span class="n">openinvtop</span> <span class="o">=</span> <span class="n">tops</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">openinvtop</span><span class="p">[</span><span class="n">openinvtop</span> <span class="o">&gt;</span> <span class="n">heads</span><span class="p">]</span> <span class="o">=</span> <span class="n">heads</span><span class="p">[</span><span class="n">openinvtop</span> <span class="o">&gt;</span> <span class="n">heads</span><span class="p">]</span>
    <span class="n">openinvtop</span><span class="p">[</span><span class="n">openinvtop</span> <span class="o">&gt;</span> <span class="n">sctoparr</span><span class="p">]</span> <span class="o">=</span> <span class="n">sctoparr</span><span class="p">[</span><span class="n">openinvtop</span> <span class="o">&gt;</span> <span class="n">screen_top</span><span class="p">]</span>

    <span class="c1"># start with layer bottoms</span>
    <span class="c1"># set bottoms below screened interval to screened interval bottom</span>
    <span class="c1"># set screen bottoms below bottoms to layer bottoms</span>
    <span class="n">openinvbotm</span> <span class="o">=</span> <span class="n">botm2d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">openinvbotm</span><span class="p">[</span><span class="n">openinvbotm</span> <span class="o">&lt;</span> <span class="n">scbotarr</span><span class="p">]</span> <span class="o">=</span> <span class="n">scbotarr</span><span class="p">[</span><span class="n">openinvbotm</span> <span class="o">&lt;</span> <span class="n">screen_botm</span><span class="p">]</span>
    <span class="n">openinvbotm</span><span class="p">[</span><span class="n">scbotarr</span> <span class="o">&lt;</span> <span class="n">botm2d</span><span class="p">]</span> <span class="o">=</span> <span class="n">botm2d</span><span class="p">[</span><span class="n">scbotarr</span> <span class="o">&lt;</span> <span class="n">botm2d</span><span class="p">]</span>

    <span class="c1"># compute thickness of open interval in each layer</span>
    <span class="n">thick</span> <span class="o">=</span> <span class="n">openinvtop</span> <span class="o">-</span> <span class="n">openinvbotm</span>

    <span class="c1"># assign open intervals above or below model to closest cell in column</span>
    <span class="n">not_in_layer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">thick</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">not_in_any_layer</span> <span class="o">=</span> <span class="n">not_in_layer</span> <span class="o">==</span> <span class="n">thick</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">not_in_any_layer</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">closest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">thick</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
            <span class="n">thick</span><span class="p">[</span><span class="n">closest</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">thick</span><span class="p">[</span><span class="n">thick</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">thick</span><span class="p">[</span><span class="n">heads</span> <span class="o">==</span> <span class="n">nodata</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># exclude nodata cells</span>
    <span class="n">thick</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">heads</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># exclude cells with no head value (inactive cells)</span>

    <span class="c1"># assign thickness of 1 to wells with no open interval</span>
    <span class="c1"># (screen top == screen bottom)</span>
    <span class="k">if</span> <span class="n">screen_top</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">screen_botm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>\
        <span class="ow">and</span> <span class="n">include_zero_open_intervals</span><span class="p">:</span>
        <span class="c1"># locations of open intervals that are within a single layer</span>
        <span class="n">in_single_layer</span> <span class="o">=</span> <span class="p">(</span><span class="n">screen_top</span> <span class="o">&lt;</span> <span class="n">tops</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">screen_botm</span> <span class="o">&gt;</span> <span class="n">botm2d</span><span class="p">)</span>
        <span class="n">zero_thickness</span> <span class="o">=</span> <span class="n">thick</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">thick</span><span class="p">[</span><span class="n">in_single_layer</span> <span class="o">&amp;</span> <span class="n">zero_thickness</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    
    <span class="c1"># compute transmissivities</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">thick</span> <span class="o">*</span> <span class="n">hk2d</span>
    <span class="k">return</span> <span class="n">T</span></div>



<div class="viewcode-block" id="read_mf6_block">
<a class="viewcode-back" href="../../api/mfobs.modflow.html#mfobs.modflow.read_mf6_block">[docs]</a>
<span class="k">def</span> <span class="nf">read_mf6_block</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">blockname</span><span class="p">):</span>
    <span class="n">blockname</span> <span class="o">=</span> <span class="n">blockname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">read</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">per</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;begin&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">blockname</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">blockname</span> <span class="o">==</span> <span class="s1">&#39;period&#39;</span><span class="p">:</span>
                    <span class="n">per</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">per</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">elif</span> <span class="n">blockname</span> <span class="o">==</span> <span class="s1">&#39;continuous&#39;</span><span class="p">:</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">elif</span> <span class="n">blockname</span> <span class="o">==</span> <span class="s1">&#39;packagedata&#39;</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;packagedata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">blockname</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">blockname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">read</span> <span class="o">=</span> <span class="n">blockname</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s1">&#39;end&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">blockname</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">per</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">read</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1">#break</span>
            <span class="k">if</span> <span class="n">read</span> <span class="o">==</span> <span class="s1">&#39;options&#39;</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">data</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">elif</span> <span class="n">read</span> <span class="o">==</span> <span class="s1">&#39;packages&#39;</span><span class="p">:</span>
                <span class="n">pckg</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">data</span><span class="p">[</span><span class="n">pckg</span><span class="p">]</span> <span class="o">=</span> <span class="n">fname</span>
            <span class="k">elif</span> <span class="n">read</span> <span class="o">==</span> <span class="s1">&#39;period&#39;</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">per</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
            <span class="k">elif</span> <span class="n">read</span> <span class="o">==</span> <span class="s1">&#39;continuous&#39;</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
            <span class="k">elif</span> <span class="n">read</span> <span class="o">==</span> <span class="s1">&#39;packagedata&#39;</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;packagedata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
            <span class="k">elif</span> <span class="n">read</span> <span class="o">==</span> <span class="n">blockname</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">blockname</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
    <span class="k">return</span> <span class="n">data</span></div>



<div class="viewcode-block" id="get_perioddata">
<a class="viewcode-back" href="../../api/mfobs.modflow.html#mfobs.modflow.get_perioddata">[docs]</a>
<span class="k">def</span> <span class="nf">get_perioddata</span><span class="p">(</span><span class="n">tdis_file</span><span class="p">,</span> <span class="n">sto_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_datetime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                   <span class="n">end_datetime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_timesteps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_time_units</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make the perioddata table required by other modflow-obs</span>
<span class="sd">    functions from a MODFLOW-6 Temporal Discretization (TDIS) file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tdis_file : str or pathlike</span>
<span class="sd">        MODFLOW 6 TDIS, or MODFLOW-2005 style DIS Package file.</span>
<span class="sd">        Model version is determined from the extension </span>
<span class="sd">        (&#39;.tdis&#39; for MODFLOW 6; &#39;.dis&#39; for MODFLOW-2005)</span>
<span class="sd">    sto_file : str or pathlike</span>
<span class="sd">        MODFLOW 6 STO Package file</span>
<span class="sd">    start_datetime : str or pandas Timestamp    </span>
<span class="sd">        Start date for model, if start date isn&#39;t specified in TDIS package file.</span>
<span class="sd">        Required for MODFLOW-2005 style models.</span>
<span class="sd">    end_datetime : str or pandas Timestamp (optional)</span>
<span class="sd">        End date of model, only required for GSFLOW models, where time-step specification </span>
<span class="sd">        is handled internally. end_datetime should be specified as midnight following</span>
<span class="sd">        the last full day simulated by the model. For example, if the model runs through</span>
<span class="sd">        12/31/2019, end_datetime should be specified as 01/01/2020.</span>
<span class="sd">    include_timesteps : bool</span>
<span class="sd">        If True, return a perioddata table with one row for each time step,</span>
<span class="sd">        otherwise, return one row per stress period.</span>
<span class="sd">        By default, False</span>
<span class="sd">    model_time_units : str (optional)</span>
<span class="sd">        Time unit of model, in text understandable by pandas (e.g. &quot;days&quot;).</span>
<span class="sd">        Specification of time units will override what is read </span>
<span class="sd">        from the TDIS or DIS package file.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    perioddata : DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tdis_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tdis_file</span><span class="p">)</span>
    <span class="n">mf6</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">tdis_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tdis&#39;</span><span class="p">):</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">read_mf6_block</span><span class="p">(</span><span class="n">tdis_file</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">)</span>
        <span class="n">perioddata</span> <span class="o">=</span> <span class="n">read_mf6_block</span><span class="p">(</span><span class="n">tdis_file</span><span class="p">,</span> <span class="s1">&#39;perioddata&#39;</span><span class="p">)</span>
        <span class="n">steady_period_blocks</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">sto_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">steady_period_blocks</span> <span class="o">=</span> <span class="n">read_mf6_block</span><span class="p">(</span><span class="n">sto_file</span><span class="p">,</span> <span class="s1">&#39;period&#39;</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="n">start_datetime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">start_datetime</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;start_date_time&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_datetime</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">start_datetime</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">start_datetime</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No start_date_time in </span><span class="si">{</span><span class="n">tdis_file</span><span class="si">}</span><span class="s1">;&#39;</span> 
                        <span class="s1">&#39;start_date_time is needed to construct perioddata.&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start_datetime</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">start_datetime</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">model_time_units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">time_units</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;time_units&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_units</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">time_units</span> <span class="o">=</span> <span class="n">time_units</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No model_time_units specified, and no time_units in </span><span class="si">{</span><span class="n">tdis_file</span><span class="si">}</span><span class="s1">;&#39;</span> 
                        <span class="s1">&#39;time units are needed to construct perioddata.&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time_units</span> <span class="o">=</span> <span class="n">model_time_units</span>
            
        <span class="n">perlen</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nstp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tsmult</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">perioddata</span><span class="p">[</span><span class="s1">&#39;perioddata&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">rperlen</span><span class="p">,</span> <span class="n">rnstp</span><span class="p">,</span> <span class="n">rtsmult</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">perlen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">rperlen</span><span class="p">))</span>
            <span class="n">nstp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rnstp</span><span class="p">))</span>
            <span class="n">tsmult</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">rtsmult</span><span class="p">))</span>
            
        <span class="k">if</span> <span class="n">steady_period_blocks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">steady</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span> <span class="k">if</span> <span class="s1">&#39;steady&#39;</span> <span class="ow">in</span> <span class="n">steady_period_blocks</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 
                    <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">perlen</span><span class="p">))]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">steady</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mf6</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">start_datetime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;start_datetimem required for MODFLOW-2005 style models&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start_datetime</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">start_datetime</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tdis_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dataset_1</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">model_time_units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">itmuni</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dataset_1</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                        <span class="n">time_units</span> <span class="o">=</span> <span class="n">itmuni_text</span><span class="p">[</span><span class="n">itmuni</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">time_units</span> <span class="o">=</span> <span class="n">model_time_units</span>
                    <span class="k">if</span> <span class="n">model_time_units</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">itmuni</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No model_time_units specified, and no time_units in </span><span class="si">{</span><span class="n">tdis_file</span><span class="si">}</span><span class="s1">;&#39;</span> 
                            <span class="s1">&#39;time units are needed to construct perioddata.&#39;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="n">perlen</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">nstp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">tsmult</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">steady</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="s1">&#39;ss&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s1">&#39;tr&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;constant&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s1">&#39;open/close&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">per_len</span><span class="p">,</span> <span class="n">per_nstp</span><span class="p">,</span> <span class="n">per_tsmult</span><span class="p">,</span> <span class="n">sstr</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="n">perlen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">per_len</span><span class="p">))</span>
                        <span class="n">nstp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">per_nstp</span><span class="p">))</span>
                        <span class="n">tsmult</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">per_tsmult</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">sstr</span> <span class="o">==</span> <span class="s1">&#39;ss&#39;</span><span class="p">:</span>
                            <span class="n">steady</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">sstr</span> <span class="o">==</span> <span class="s1">&#39;tr&#39;</span><span class="p">:</span>
                            <span class="n">steady</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid input for DIS package dataset 7, Ss/tr:</span><span class="se">\n</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">perlen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">perlen</span><span class="p">)</span>
    <span class="n">actual_period_length</span> <span class="o">=</span> <span class="n">perlen</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">steady</span><span class="p">)</span> <span class="ow">and</span> <span class="n">steady</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">actual_period_length</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">actual_period_length</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">start_elapsed_times</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">elapsed_time</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">start_datetimes</span> <span class="o">=</span> <span class="n">start_datetime</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">start_elapsed_times</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">time_units</span><span class="p">)</span>
    
    <span class="c1"># determine perlen and number of steps for a GSFLOW model with specified end date</span>
    <span class="c1"># (model is assumed to have time units of days</span>
    <span class="c1"># and daily timesteps)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mf6</span> <span class="ow">and</span> <span class="n">end_datetime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">end_datetime</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">end_datetime</span><span class="p">)</span>
        <span class="n">perlen</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_datetime</span> <span class="o">-</span> <span class="n">start_datetimes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">days</span>
        <span class="n">nstp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">perlen</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">end_datetimes</span> <span class="o">=</span> <span class="n">start_datetimes</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">perlen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="c1"># modflow time (includes length of initial steady-state period)</span>
    <span class="n">mf_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">perlen</span><span class="p">)</span>
    
    <span class="n">perioddata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;start_datetime&#39;</span><span class="p">:</span> <span class="n">start_datetimes</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>
                               <span class="s1">&#39;end_datetime&#39;</span><span class="p">:</span> <span class="n">end_datetimes</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>
                               <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">mf_time</span><span class="p">,</span>
                               <span class="s1">&#39;per&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">perlen</span><span class="p">)),</span>
                               <span class="s1">&#39;perlen&#39;</span><span class="p">:</span> <span class="n">perlen</span><span class="p">,</span>
                               <span class="s1">&#39;nstp&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nstp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
                               <span class="s1">&#39;tsmult&#39;</span><span class="p">:</span> <span class="n">tsmult</span><span class="p">,</span>
                               <span class="s1">&#39;steady&#39;</span><span class="p">:</span> <span class="n">steady</span>
                               <span class="p">})</span>
    
    <span class="k">if</span> <span class="n">include_timesteps</span><span class="p">:</span>
        <span class="n">perioddata</span> <span class="o">=</span> <span class="n">add_timesteps_to_perioddata</span><span class="p">(</span><span class="n">perioddata</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">perioddata</span></div>



<div class="viewcode-block" id="add_timesteps_to_perioddata">
<a class="viewcode-back" href="../../api/mfobs.modflow.html#mfobs.modflow.add_timesteps_to_perioddata">[docs]</a>
<span class="k">def</span> <span class="nf">add_timesteps_to_perioddata</span><span class="p">(</span><span class="n">perioddata</span><span class="p">):</span>
    
    <span class="c1"># check that perlens are consistent with elapsed MODFLOW times</span>
    <span class="n">calc_perlen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">perioddata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">calc_perlen</span><span class="p">,</span> <span class="n">perioddata</span><span class="p">[</span><span class="s1">&#39;perlen&#39;</span><span class="p">]):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Specified perlen and times are inconsistent</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="sa">f</span><span class="s1">&#39;times: </span><span class="si">{</span><span class="n">perioddata</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="sa">f</span><span class="s1">&#39;perlen: </span><span class="si">{</span><span class="n">perioddata</span><span class="o">.</span><span class="n">perlen</span><span class="o">.</span><span class="n">values</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
               <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">perioddata</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        
        <span class="n">perlen</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;perlen&#39;</span><span class="p">]</span>
        <span class="n">tsmult</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;tsmult&#39;</span><span class="p">]</span>
        <span class="n">nstp</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;nstp&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tsmult</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ti</span> <span class="o">=</span> <span class="n">perlen</span> <span class="o">/</span> <span class="n">nstp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># get the initial timestep size</span>
            <span class="n">ti</span> <span class="o">=</span> <span class="n">perlen</span><span class="o">*</span><span class="p">(</span><span class="n">tsmult</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">tsmult</span><span class="o">**</span><span class="n">nstp</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># remaining timestep sizes</span>
        <span class="n">timesteps</span> <span class="o">=</span> <span class="p">[</span><span class="n">ti</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">ti</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cumprod</span><span class="p">([</span><span class="n">tsmult</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">nstp</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">timesteps</span><span class="p">),</span> <span class="n">perlen</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">nstp</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># make a dataframe for the stress period</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">]</span> <span class="o">*</span> <span class="n">nstp</span><span class="p">)</span>
            <span class="n">end_datetimes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;start_datetime&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">timesteps</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
            <span class="n">start_datetimes</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;start_datetime&#39;</span><span class="p">])]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">end_datetimes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;start_datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_datetimes</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;end_datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_datetimes</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">timesteps</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]]</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">]</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;perlen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">perlen</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;nstp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nstp</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tsmult&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsmult</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nstp</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;timestep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            
        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="n">timestepdata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;perlen&#39;</span><span class="p">,</span> <span class="s1">&#39;tsmult&#39;</span><span class="p">:</span>
        <span class="n">timestepdata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestepdata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="s1">&#39;per&#39;</span><span class="p">,</span> <span class="s1">&#39;nstp&#39;</span><span class="p">,</span> <span class="s1">&#39;timestep&#39;</span><span class="p">:</span>
        <span class="n">timestepdata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestepdata</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">timestepdata</span>        </div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
      <span class="lastupdated">Last updated on Dec 06, 2024.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>